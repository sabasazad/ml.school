<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ml.school - Machine Learning In Production Using SageMaker</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="ml.school - Machine Learning In Production Using SageMaker">
<meta property="og:description" content="">
<meta property="og:site-name" content="ml.school">
<meta name="twitter:title" content="ml.school - Machine Learning In Production Using SageMaker">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ml.school</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Machine Learning In Production Using SageMaker</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cohort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building Production Machine Learning Systems</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link active" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#training-pipeline" id="toc-training-pipeline" class="nav-link" data-scroll-target="#training-pipeline">Training Pipeline</a>
  <ul class="collapse">
  <li><a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing">Preprocessing</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  <li><a href="#tuning" id="toc-tuning" class="nav-link" data-scroll-target="#tuning">Tuning</a></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation">Evaluation</a></li>
  <li><a href="#inference-pipeline" id="toc-inference-pipeline" class="nav-link" data-scroll-target="#inference-pipeline">Inference Pipeline</a>
  <ul class="collapse">
  <li><a href="#preprocessing-script" id="toc-preprocessing-script" class="nav-link" data-scroll-target="#preprocessing-script">Preprocessing Script</a></li>
  <li><a href="#postprocessing-script" id="toc-postprocessing-script" class="nav-link" data-scroll-target="#postprocessing-script">Postprocessing Script</a></li>
  <li><a href="#pipeline-model" id="toc-pipeline-model" class="nav-link" data-scroll-target="#pipeline-model">Pipeline Model</a></li>
  </ul></li>
  <li><a href="#data-quality-baseline" id="toc-data-quality-baseline" class="nav-link" data-scroll-target="#data-quality-baseline">Data Quality Baseline</a></li>
  <li><a href="#model-quality-baseline" id="toc-model-quality-baseline" class="nav-link" data-scroll-target="#model-quality-baseline">Model Quality Baseline</a></li>
  <li><a href="#registration" id="toc-registration" class="nav-link" data-scroll-target="#registration">Registration</a></li>
  <li><a href="#condition-step" id="toc-condition-step" class="nav-link" data-scroll-target="#condition-step">Condition Step</a></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline">Pipeline</a></li>
  <li><a href="#quality-baselines" id="toc-quality-baselines" class="nav-link" data-scroll-target="#quality-baselines">Quality Baselines</a></li>
  </ul></li>
  <li><a href="#model-deployment" id="toc-model-deployment" class="nav-link" data-scroll-target="#model-deployment">Model Deployment</a>
  <ul class="collapse">
  <li><a href="#lambda" id="toc-lambda" class="nav-link" data-scroll-target="#lambda">Lambda</a></li>
  <li><a href="#eventbridge" id="toc-eventbridge" class="nav-link" data-scroll-target="#eventbridge">EventBridge</a></li>
  <li><a href="#predictions" id="toc-predictions" class="nav-link" data-scroll-target="#predictions">Predictions</a></li>
  <li><a href="#data-capture" id="toc-data-capture" class="nav-link" data-scroll-target="#data-capture">Data Capture</a></li>
  <li><a href="#clean-up" id="toc-clean-up" class="nav-link" data-scroll-target="#clean-up">Clean up</a></li>
  </ul></li>
  <li><a href="#model-monitoring" id="toc-model-monitoring" class="nav-link" data-scroll-target="#model-monitoring">Model Monitoring</a>
  <ul class="collapse">
  <li><a href="#fake-traffic" id="toc-fake-traffic" class="nav-link" data-scroll-target="#fake-traffic">Fake Traffic</a></li>
  <li><a href="#fake-labels" id="toc-fake-labels" class="nav-link" data-scroll-target="#fake-labels">Fake Labels</a></li>
  <li><a href="#monitoring-jobs" id="toc-monitoring-jobs" class="nav-link" data-scroll-target="#monitoring-jobs">Monitoring Jobs</a>
  <ul class="collapse">
  <li><a href="#data-monitoring" id="toc-data-monitoring" class="nav-link" data-scroll-target="#data-monitoring">Data Monitoring</a></li>
  <li><a href="#model-monitoring-1" id="toc-model-monitoring-1" class="nav-link" data-scroll-target="#model-monitoring-1">Model Monitoring</a></li>
  <li><a href="#clean-up-1" id="toc-clean-up-1" class="nav-link" data-scroll-target="#clean-up-1">Clean up</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/svpino/ml.school/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Machine Learning In Production Using SageMaker</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell" data-tags="[]" data-execution_count="269">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>CODE_FOLDER <span class="op">=</span> Path(<span class="st">"code"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>CODE_FOLDER.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="ss">f"./</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
The dotenv extension is already loaded. To reload it, use:
  %reload_ext dotenv</code></pre>
</div>
</div>
<p>To run this notebook in <strong>Local Mode</strong> set the <code>LOCAL_MODE</code> constant to <code>True</code>.</p>
<p>To build our system using SageMaker, we need access to <code>ml.m5.xlarge</code> instances. By default, the quota on a new AWS account is zero, so you need to request a quota increase. You can do that under Service Quotas &gt; AWS Services &gt; Amazon SageMaker. Find <code>ml.m5.xlarge</code> and request a quota increase for processing jobs, training jobs, transform jobs, and endpoint usage. In the meantime, you can use <code>ml.t3.large</code> as a substitute.</p>
<div class="cell" data-tags="[]" data-execution_count="270">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># By default, The SageMaker SDK logs events related to the default</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># configuration using the INFO level. To prevent these from spoiling</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the output of this notebook cells, we can change the logging</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># level to ERROR instead.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>logging.getLogger(<span class="st">"sagemaker.config"</span>).setLevel(logging.ERROR)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_context <span class="im">import</span> PipelineSession, LocalPipelineSession</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>LOCAL_MODE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>BUCKET <span class="op">=</span> os.environ[<span class="st">"BUCKET"</span>]</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># If you are running this notebook on an ARM64 machine, you will need</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># to build a custom Docker image using the setup notebook. This is</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># because SageMaker doesn't provide a TensorFlow image that supports </span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The Apple M chips.</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>architecture <span class="op">=</span> <span class="op">!</span>(uname <span class="op">-</span>m)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>IS_APPLE_M_CHIP <span class="op">=</span> architecture[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"arm64"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll use these two variables to configure the steps that do not support</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Local Mode.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>pipeline_session <span class="op">=</span> PipelineSession(default_bucket<span class="op">=</span>BUCKET) <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> LOCAL_MODE:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: LocalPipelineSession(default_bucket<span class="op">=</span>BUCKET),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"local"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to use a custom Docker image when we run the pipeline</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in Local Model on an ARM64 machine.</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: <span class="st">"sagemaker-tensorflow-training-toolkit-local"</span> <span class="cf">if</span> IS_APPLE_M_CHIP <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"framework_version"</span>: <span class="va">None</span> <span class="cf">if</span> IS_APPLE_M_CHIP <span class="cf">else</span> <span class="st">"2.11"</span>,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"py_version"</span>: <span class="va">None</span> <span class="cf">if</span> IS_APPLE_M_CHIP <span class="cf">else</span> <span class="st">"py39"</span>,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: pipeline_session,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: <span class="va">None</span>,        </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"framework_version"</span>: <span class="st">"2.11"</span>,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"py_version"</span>: <span class="st">"py39"</span>,</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exploratory-data-analysis" class="level1">
<h1>Exploratory Data Analysis</h1>
<p>Let’s run Exploratory Data Analysis on the dataset. The goal of this section is to understand the data and the problem we are trying to solve.</p>
<p>The first step is to create an S3 bucket where we will store the data and every resource we are going to create.</p>
<div class="alert" style="background-color:#6e420c; color: #fff">
<p><strong>Note:</strong> If you want to create a bucket in a region other than <strong>us-east-1</strong>, you need to use the “–create-bucket-configuration” argument when creating the bucket. You can see an example below.</p>
</div>
<p>Example of how to specify a region different from <code>us-east-1</code> when creating a bucket:</p>
<pre><code>!aws s3api create-bucket --bucket $BUCKET --create-bucket-configuration LocationConstraint="eu-west-1"</code></pre>
<p>The <code>LocationConstraint</code> argument should specify the region where you want to create the bucket. The example above creates the bucket in the <code>eu-west-1</code> region.</p>
<div class="cell" data-tags="[]" data-execution_count="271">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>aws s3api create<span class="op">-</span>bucket <span class="op">--</span>bucket $BUCKET</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "Location": "/mlschool"
}</code></pre>
</div>
</div>
<p>After we have a bucket, we can download the <a href="https://www.kaggle.com/parulpandey/palmer-archipelago-antarctica-penguin-data">Penguins dataset</a> and store it in the bucket.</p>
<div class="cell" data-tags="[]" data-execution_count="272">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Uploader</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>S3_LOCATION <span class="op">=</span> <span class="ss">f"s3://</span><span class="sc">{</span>BUCKET<span class="sc">}</span><span class="ss">/penguins"</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>DATA_FILEPATH <span class="op">=</span> CODE_FOLDER <span class="op">/</span> <span class="st">"data.csv"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>urllib.request.urlretrieve(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://storage.googleapis.com/download.tensorflow.org/data/palmer_penguins/penguins_size.csv"</span>, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    DATA_FILEPATH</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>S3Uploader.upload(local_path<span class="op">=</span><span class="bu">str</span>(DATA_FILEPATH), desired_s3_uri<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="272">
<pre><code>'s3://mlschool/penguins/data/data.csv'</code></pre>
</div>
</div>
<p>Let’s load the Penguins dataset. The data contains the following columns:</p>
<ol type="1">
<li><code>species</code>: The species of a penguin. This is the column we want to predict.</li>
<li><code>island</code>: The island where the penguin was found</li>
<li><code>culmen_length_mm</code>: The length of the penguin’s culmen (bill) in millimeters</li>
<li><code>culmen_depth_mm</code>: The depth of the penguin’s culmen in millimeters</li>
<li><code>flipper_length_mm</code>: The length of the penguin’s flipper in millimeters</li>
<li><code>body_mass_g</code>: The body mass of the penguin in grams</li>
<li><code>sex</code>: The sex of the penguin</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="273">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>penguins.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="273">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.1</td>
<td>18.7</td>
<td>181.0</td>
<td>3750.0</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.5</td>
<td>17.4</td>
<td>186.0</td>
<td>3800.0</td>
<td>FEMALE</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>40.3</td>
<td>18.0</td>
<td>195.0</td>
<td>3250.0</td>
<td>FEMALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>36.7</td>
<td>19.3</td>
<td>193.0</td>
<td>3450.0</td>
<td>FEMALE</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now, let’s get the summary statistics for the features in our dataset.</p>
<div class="cell" data-tags="[]" data-execution_count="274">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>penguins.describe(include<span class="op">=</span><span class="st">'all'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="274">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>344</td>
<td>344</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>334</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>3</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>Adelie</td>
<td>Biscoe</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>152</td>
<td>168</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>NaN</td>
<td>NaN</td>
<td>43.921930</td>
<td>17.151170</td>
<td>200.915205</td>
<td>4201.754386</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>NaN</td>
<td>NaN</td>
<td>5.459584</td>
<td>1.974793</td>
<td>14.061714</td>
<td>801.954536</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>NaN</td>
<td>NaN</td>
<td>32.100000</td>
<td>13.100000</td>
<td>172.000000</td>
<td>2700.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>NaN</td>
<td>NaN</td>
<td>39.225000</td>
<td>15.600000</td>
<td>190.000000</td>
<td>3550.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>NaN</td>
<td>NaN</td>
<td>44.450000</td>
<td>17.300000</td>
<td>197.000000</td>
<td>4050.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>NaN</td>
<td>NaN</td>
<td>48.500000</td>
<td>18.700000</td>
<td>213.000000</td>
<td>4750.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>NaN</td>
<td>NaN</td>
<td>59.600000</td>
<td>21.500000</td>
<td>231.000000</td>
<td>6300.000000</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The distribution of the categories in our dataset are:</p>
<ul>
<li><code>species</code>: There are 3 species of penguins in the dataset: Adelie (152), Gentoo (124), and Chinstrap (68).</li>
<li><code>island</code>: Penguins are from 3 islands: Biscoe (168), Dream (124), and Torgersen (52).</li>
<li><code>sex</code>: We have 168 male penguins, 165 female penguins, and 1 penguin with an ambiguous gender (‘.’).</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="275">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>species_distribution <span class="op">=</span> penguins[<span class="st">'species'</span>].value_counts()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>island_distribution <span class="op">=</span> penguins[<span class="st">'island'</span>].value_counts()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sex_distribution <span class="op">=</span> penguins[<span class="st">'sex'</span>].value_counts()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(species_distribution)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(island_distribution)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sex_distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>species
Adelie       152
Gentoo       124
Chinstrap     68
Name: count, dtype: int64

island
Biscoe       168
Dream        124
Torgersen     52
Name: count, dtype: int64

sex
MALE      168
FEMALE    165
.           1
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>Let’s replace the ambiguous value in the <code>sex</code> column with a null value.</p>
<div class="cell" data-tags="[]" data-execution_count="276">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>penguins[<span class="st">"sex"</span>] <span class="op">=</span> penguins[<span class="st">"sex"</span>].replace(<span class="st">"."</span>, np.nan)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>penguins[<span class="st">"sex"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="276">
<pre><code>sex
MALE      168
FEMALE    165
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>Next, let’s check for any missing values in the dataset.</p>
<div class="cell" data-tags="[]" data-execution_count="277">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>penguins.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="277">
<pre><code>species               0
island                0
culmen_length_mm      2
culmen_depth_mm       2
flipper_length_mm     2
body_mass_g           2
sex                  11
dtype: int64</code></pre>
</div>
</div>
<p>Let’s get rid of the missing values. For now, we are going to replace the missing values with the most frequent value in the column. Later, we’ll use a different strategy to replace missing numeric values.</p>
<div class="cell" data-tags="[]" data-execution_count="278">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>penguins.iloc[:,:] <span class="op">=</span> imputer.fit_transform(penguins)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>penguins.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="278">
<pre><code>species              0
island               0
culmen_length_mm     0
culmen_depth_mm      0
flipper_length_mm    0
body_mass_g          0
sex                  0
dtype: int64</code></pre>
</div>
</div>
<p>Let’s visualize the distribution of categorical features.</p>
<div class="cell" data-tags="[]" data-execution_count="279">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objs <span class="im">as</span> go</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows<span class="op">=</span><span class="dv">3</span>, cols<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>species_distribution.index, y<span class="op">=</span>species_distribution.values, name<span class="op">=</span><span class="st">'species'</span>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>island_distribution.index, y<span class="op">=</span>island_distribution.values, name<span class="op">=</span><span class="st">'island'</span>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>sex_distribution.index, y<span class="op">=</span>sex_distribution.values, name<span class="op">=</span><span class="st">'sex'</span>), row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height<span class="op">=</span><span class="dv">700</span>, width<span class="op">=</span><span class="dv">960</span>, title_text<span class="op">=</span><span class="st">"Distribution of Categorical Features"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>Let’s visualize the distribution of numerical columns.</p>
<div class="cell" data-tags="[]" data-execution_count="280">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows<span class="op">=</span><span class="dv">2</span>, cols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Histogram(x<span class="op">=</span>penguins[<span class="st">'culmen_length_mm'</span>], name<span class="op">=</span><span class="st">'culmen_length_mm'</span>, nbinsx<span class="op">=</span><span class="dv">20</span>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Histogram(x<span class="op">=</span>penguins[<span class="st">'culmen_depth_mm'</span>], name<span class="op">=</span><span class="st">'culmen_depth_mm'</span>, nbinsx<span class="op">=</span><span class="dv">20</span>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Histogram(x<span class="op">=</span>penguins[<span class="st">'flipper_length_mm'</span>], name<span class="op">=</span><span class="st">'flipper_length_mm'</span>, nbinsx<span class="op">=</span><span class="dv">20</span>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Histogram(x<span class="op">=</span>penguins[<span class="st">'body_mass_g'</span>], name<span class="op">=</span><span class="st">'body_mass_g'</span>, nbinsx<span class="op">=</span><span class="dv">20</span>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height<span class="op">=</span><span class="dv">700</span>, width<span class="op">=</span><span class="dv">960</span>, title_text<span class="op">=</span><span class="st">"Distribution of Numerical Features"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>Let’s display a scatter matrix with every numeric feature from our dataset.</p>
<div class="cell" data-tags="[]" data-execution_count="281">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.scatter_matrix(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    penguins, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    dimensions<span class="op">=</span>[<span class="st">"culmen_length_mm"</span>, <span class="st">"culmen_depth_mm"</span>, <span class="st">"flipper_length_mm"</span>, <span class="st">"body_mass_g"</span>], </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"species"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height<span class="op">=</span><span class="dv">800</span>, width<span class="op">=</span><span class="dv">960</span>, title_text<span class="op">=</span><span class="st">"Scatter Matrix of Numeric Features"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>Let’s display the covariance matrix of the dataset. The “covariance” measures how changes in one variable are associated with changes in a second variable. In other words, the covariance measures the degree to which two variables are linearly associated.</p>
<p>Here are three examples of what we get from interpreting the covariance matrix below:</p>
<ol type="1">
<li>Penguins that weight more tend to have a larger culmen.</li>
<li>The more a penguin weights, the shallower its culmen tends to be.</li>
<li>There’s a small variance between the culmen depth of penguins.</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="282">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>penguins.cov(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="282">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>29.679415</td>
<td>-2.516984</td>
<td>50.260588</td>
<td>2596.971151</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-2.516984</td>
<td>3.877201</td>
<td>-16.108849</td>
<td>-742.660180</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>50.260588</td>
<td>-16.108849</td>
<td>197.269501</td>
<td>9792.552037</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>2596.971151</td>
<td>-742.660180</td>
<td>9792.552037</td>
<td>640316.716388</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s now display the correlation matrix. “Correlation” measures both the strength and direction of the linear relationship between two variables.</p>
<p>Here are three examples of what we get from interpreting the correlation matrix below:</p>
<ol type="1">
<li>Penguins that weight more tend to have larger flippers.</li>
<li>Penguins with a shallower culmen tend to have larger flippers.</li>
<li>The length and depth of the culmen have a slight negative correlation.</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="283">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>penguins.corr(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="283">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>1.000000</td>
<td>-0.234635</td>
<td>0.656856</td>
<td>0.595720</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-0.234635</td>
<td>1.000000</td>
<td>-0.582472</td>
<td>-0.471339</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>0.656856</td>
<td>-0.582472</td>
<td>1.000000</td>
<td>0.871302</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>0.595720</td>
<td>-0.471339</td>
<td>0.871302</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s display the distribution of species by island.</p>
<div class="cell" data-tags="[]" data-execution_count="284">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.histogram(penguins, x<span class="op">=</span><span class="st">"island"</span>, color<span class="op">=</span><span class="st">"species"</span>, nbins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">800</span>, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">960</span>, </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    title_text<span class="op">=</span><span class="st">"Distribution of Species by Island"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    xaxis_title_text<span class="op">=</span><span class="st">'island'</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    yaxis_title_text<span class="op">=</span><span class="st">'count'</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    bargap<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    bargroupgap<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>Let’s display the distribution of species by sex.</p>
<div class="cell" data-tags="[]" data-execution_count="285">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.histogram(penguins, x<span class="op">=</span><span class="st">"sex"</span>, color<span class="op">=</span><span class="st">"species"</span>, nbins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">800</span>, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">960</span>, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    title_text<span class="op">=</span><span class="st">"Distribution of Species by Sex"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    xaxis_title_text<span class="op">=</span><span class="st">'sex'</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    yaxis_title_text<span class="op">=</span><span class="st">'count'</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    bargap<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    bargroupgap<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
</section>
<section id="training-pipeline" class="level1">
<h1>Training Pipeline</h1>
<p>In this section, we’ll create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> to automate the process of building, evaluating, and registering a model. We’ll use the <a href="https://sagemaker.readthedocs.io/en/stable/">SageMaker Python SDK</a> to create the Pipeline. Check the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipelines Overview</a> for an introduction to the fundamental components of a SageMaker Pipeline.</p>
<p>We can define a caching policy to reuse the result of a previous successful run of a pipeline step. You can find more information about this topic in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-caching.html">Caching Pipeline Steps</a>.</p>
<div class="cell" data-tags="[]" data-execution_count="286">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ipytest</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> CacheConfig</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>ipytest.autoconfig(raise_on_error<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>sagemaker_session <span class="op">=</span> sagemaker.session.Session()</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>sagemaker_client <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>iam_client <span class="op">=</span> boto3.client(<span class="st">"iam"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> boto3.Session().region_name</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>cache_config <span class="op">=</span> CacheConfig(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    enable_caching<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    expire_after<span class="op">=</span><span class="st">"15d"</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing">Preprocessing</h2>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to split and transform the data.</p>
<p>Let’s create the preprocessing script. The Processing Step will spin up a Processing Job and run this script inside a container.</p>
<div class="cell" data-tags="[]" data-execution_count="287">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer, make_column_selector</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline, make_pipeline</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, StandardScaler, OrdinalEncoder</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess(base_directory):</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">    This function loads the supplied data, splits it and transforms it.</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> _read_data_from_input_csv_files(base_directory)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    target_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[(<span class="st">"species"</span>, OrdinalEncoder(), [<span class="dv">0</span>])]</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    numeric_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"mean"</span>),</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        StandardScaler()</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    categorical_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>),</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        OneHotEncoder()</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    features_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"numeric"</span>, numeric_transformer, make_column_selector(dtype_exclude<span class="op">=</span><span class="st">"object"</span>)),</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"categorical"</span>, categorical_transformer, [<span class="st">"island"</span>]),</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    df_train, df_validation, df_test <span class="op">=</span> _split_data(df)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    _save_baseline(base_directory, df_test)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> target_transformer.fit_transform(np.array(df_train.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    y_validation <span class="op">=</span> target_transformer.transform(np.array(df_validation.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> target_transformer.transform(np.array(df_test.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> df_train.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    df_validation <span class="op">=</span> df_validation.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    df_test <span class="op">=</span> df_test.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> features_transformer.fit_transform(df_train)</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    X_validation <span class="op">=</span> features_transformer.transform(df_validation)</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> features_transformer.transform(df_test)</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    _save_splits(base_directory, X_train, y_train, X_validation, y_validation, X_test, y_test)</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    _save_model(base_directory, target_transformer, features_transformer)</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _read_data_from_input_csv_files(base_directory):</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a><span class="co">    This function reads every CSV file available and concatenates</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="co">    them into a single dataframe.</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> input_directory.glob(<span class="st">"*.csv"</span>)]</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(files) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"The are no CSV files in </span><span class="sc">{</span><span class="bu">str</span>(input_directory)<span class="sc">}</span><span class="ss">/"</span>)</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    raw_data <span class="op">=</span> [pd.read_csv(<span class="bu">file</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files]</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat(raw_data)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shuffle the data</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _split_data(df):</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="co">    Splits the data into three sets: train, validation and test.</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>    df_train, temp <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>    df_validation, df_test <span class="op">=</span> train_test_split(temp, test_size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_train, df_validation, df_test</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _save_baseline(base_directory, df_test):</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a><span class="co">    This function saves the untransformed test split to disk. This file will</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a><span class="co">    be used later as a baseline to monitor the performance of the model.</span></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>    baseline_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="ss">f"baseline"</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>    baseline_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>    df_test.to_csv(baseline_path <span class="op">/</span> <span class="st">"baseline.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _save_splits(base_directory, X_train, y_train, X_validation, y_validation, X_test, y_test):</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="co">    This function concatenates the transformed features and the target variable, and</span></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="co">    saves each one of the split sets to disk.</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> np.concatenate((X_train, y_train), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>    validation <span class="op">=</span> np.concatenate((X_validation, y_validation), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>    test <span class="op">=</span> np.concatenate((X_test, y_test), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>    train_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    validation_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"validation"</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>    test_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>    train_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>    validation_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>    test_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(train).to_csv(train_path <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(validation).to_csv(validation_path <span class="op">/</span> <span class="st">"validation.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(test).to_csv(test_path <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _save_model(base_directory, target_transformer, features_transformer):</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="co">    This function creates a model.tar.gz file that contains the two transformation</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a><span class="co">    pipelines we built to transform the data.</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> directory:</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>        joblib.dump(target_transformer, os.path.join(directory, <span class="st">"target.joblib"</span>))</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>        joblib.dump(features_transformer, os.path.join(directory, <span class="st">"features.joblib"</span>))</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>        model_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>        model_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tarfile.<span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">str</span>(model_path <span class="op">/</span> <span class="st">'model.tar.gz'</span>)<span class="sc">}</span><span class="ss">"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>            tar.add(os.path.join(directory, <span class="st">"target.joblib"</span>), arcname<span class="op">=</span><span class="st">"target.joblib"</span>)</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>            tar.add(os.path.join(directory, <span class="st">"features.joblib"</span>), arcname<span class="op">=</span><span class="st">"features.joblib"</span>)</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span><span class="st">"/opt/ml/processing"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/preprocessor.py</code></pre>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected.</p>
<div class="cell" data-tags="[]" data-execution_count="288">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_data_splits(directory):</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"train"</span> <span class="kw">in</span> output_directories</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"validation"</span> <span class="kw">in</span> output_directories</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"test"</span> <span class="kw">in</span> output_directories</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_baseline(directory):</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"baseline"</span> <span class="kw">in</span> output_directories</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_creates_two_models(directory):</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    model_path <span class="op">=</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    tar <span class="op">=</span> tarfile.<span class="bu">open</span>(model_path <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"r:gz"</span>)</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"features.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"target.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_splits_are_transformed(directory):</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train"</span> <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    validation <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"validation"</span> <span class="op">/</span> <span class="st">"validation.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    test <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test"</span> <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After transforming the data, the number of features should be 7:</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 3 - island (one-hot encoded)</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_length_mm = 1</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_depth_mm</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - flipper_length_mm</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - body_mass_g</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    number_of_features <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The transformed splits should have an additional column for the target</span></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variable.</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> train.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> validation.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> test.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_baseline_is_not_transformed(directory):</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"baseline"</span> <span class="op">/</span> <span class="st">"baseline.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>    island <span class="op">=</span> baseline.iloc[:, <span class="dv">1</span>].unique()</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Biscoe"</span> <span class="kw">in</span> island</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Torgersen"</span> <span class="kw">in</span> island</span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Dream"</span> <span class="kw">in</span> island</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.....
5 passed in 0.30s</code></pre>
</div>
</div>
<p>The first step we need in the pipeline is a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to run the preprocessing script. This Processing Step will create a SageMaker Processing Job in the background, run the script, and upload the output to S3. You can use Processing Jobs to perform data preprocessing, post-processing, feature engineering, data validation, and model evaluation. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>We can parameterize a SageMaker Pipeline to make it more flexible. To read more about these parameters, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameters</a>. The <code>dataset_location</code> represents the location of the data we can to process in our pipeline. We can execute the pipeline with different datasets by changing the value of this parameter.</p>
<p>A processor gives the Processing Step information about the hardware and software that SageMaker should use to launch the Processing Job. To run the script, we need access to Scikit-Learn, so we can use the <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor">SKLearnProcessor</a> processor that comes out-of-the-box with the SageMaker’s Python SDK. The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks.html">Data Processing with Framework Processors</a> page discusses other built-in processors you can use. The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">Docker Registry Paths and Example Code</a> page contains information about the available framework versions for each region.</p>
<p>The <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> requires a list of inputs that we need on the preprocessing script. In this case, the input is the dataset we stored in S3. We also have a few outputs that we want SageMaker to capture when the Processing Job finishes.</p>
<div class="cell" data-tags="[]" data-execution_count="289">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.processing <span class="im">import</span> SKLearnProcessor</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> ProcessingStep</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.processing <span class="im">import</span> ProcessingInput, ProcessingOutput</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterString</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>dataset_location <span class="op">=</span> ParameterString(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"dataset_location"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/data"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> SKLearnProcessor(</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"split-and-transform-data"</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># By default, a new account doesn't have access to `ml.m5.xlarge` instances.</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you haven't requested a quota increase yet, you can use an</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `ml.t3.medium` instance type instead. This will work out of the box, but</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the Processing Job will take significantly longer than it should have.</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To get access to `ml.m5.xlarge` instances, you can request a quota </span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># increase under the Service Quotas section in your AWS account.</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>split_and_transform_data_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"split-and-transform-data"</span>,</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>processor.run(</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/preprocessor.py"</span>,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(source<span class="op">=</span>dataset_location, destination<span class="op">=</span><span class="st">"/opt/ml/processing/input"</span>),  </span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"train"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/train"</span>),</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"validation"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/validation"</span>),</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"test"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span>),</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"model"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>),</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The baseline output points to the test set before transforming the data. This set</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># will be helpful to generate a quality baseline for the model performance.</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"baseline"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/baseline"</span>),</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker.image_uris:Defaulting to only available Python version: py3
/Users/svpino/dev/ml.school/.venv/lib/python3.9/site-packages/sagemaker/workflow/pipeline_context.py:297: UserWarning:

Running within a PipelineSession, there will be No Wait, No Logs, and No Job being started.
</code></pre>
</div>
</div>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a> to build a model.</p>
<p>This following script is responsible for training a neural network using the train data, validating the model, and saving it so we can later use it.</p>
<div class="cell" data-tags="[]" data-execution_count="290">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> SGD</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model_directory, train_path, validation_path, epochs<span class="op">=</span><span class="dv">50</span>, batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    train_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> Path(train_path).glob(<span class="st">"*.csv"</span>)]</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    validation_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> Path(validation_path).glob(<span class="st">"*.csv"</span>)]</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(train_files) <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">len</span>(validation_files) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"The are no train or validation files"</span>)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    train_data <span class="op">=</span> [pd.read_csv(<span class="bu">file</span>, header<span class="op">=</span><span class="va">None</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> train_files]</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> pd.concat(train_data)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> X_train[X_train.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    X_train.drop(X_train.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    validation_data <span class="op">=</span> [pd.read_csv(<span class="bu">file</span>, header<span class="op">=</span><span class="va">None</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> validation_files]</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    X_validation <span class="op">=</span> pd.concat(validation_data)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    y_validation <span class="op">=</span> X_validation[X_validation.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    X_validation.drop(X_validation.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">10</span>, input_shape<span class="op">=</span>(X_train.shape[<span class="dv">1</span>],), activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">8</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">"softmax"</span>),</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>SGD(learning_rate<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">"sparse_categorical_crossentropy"</span>,</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    model.fit(</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>        X_train, </span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        y_train, </span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>        validation_data<span class="op">=</span>(X_validation, y_validation),</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>epochs, </span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_validation), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Validation accuracy: </span><span class="sc">{</span>accuracy_score(y_validation, predictions)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    model_filepath <span class="op">=</span> Path(model_directory) <span class="op">/</span> <span class="st">"001"</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    model.save(model_filepath)    </span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Any hyperparameters provided by the training job are passed to </span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the entry point as script arguments. </span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--epochs"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--batch_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    args, _ <span class="op">=</span> parser.parse_known_args()</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is the location where we need to save our model. SageMaker will</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create a model.tar.gz file with anything inside this directory when</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the training script finishes.</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>os.environ[<span class="st">"SM_MODEL_DIR"</span>],</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SageMaker creates one channel for each one of the inputs to the</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training Step.</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_TRAIN"</span>],</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_VALIDATION"</span>],</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>args.epochs,</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>args.batch_size,</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/train.py</code></pre>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected.</p>
<div class="cell" data-tags="[]" data-execution_count="291">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> train <span class="im">import</span> train</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>, </span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_saves_a_folder_with_model_assets(directory):</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"001"</span> <span class="kw">in</span> output</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"saved_model.pb"</span> <span class="kw">in</span> assets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.SGD` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.SGD`.
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp04ai5la6/model/001/assets</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>8/8 - 0s - loss: 1.0332 - accuracy: 0.4417 - val_loss: 1.0067 - val_accuracy: 0.4808 - 202ms/epoch - 25ms/step
2/2 [==============================] - 0s 1ms/step
Validation accuracy: 0.4807692307692308
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp04ai5la6/model/001/assets
.
1 passed in 0.45s</code></pre>
</div>
</div>
<p>SageMaker uses the concept of an <a href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html">Estimator</a> to handle end-to-end training tasks. For this example, we will use the built-in <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-estimator">TensorFlow Estimator</a> to run the training script we wrote before. The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">Docker Registry Paths and Example Code</a> page contains information about the available framework versions for each region. Here, you can also check the available SageMaker <a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Deep Learning Container images</a>.</p>
<div class="cell" data-tags="[]" data-execution_count="292">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlow</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>estimator <span class="op">=</span> TensorFlow(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"training"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/train.py"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will pass these hyperparameters as arguments</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to the entry point of the training script.</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    hyperparameters<span class="op">=</span>{</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: <span class="dv">50</span>,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_size"</span>: <span class="dv">32</span>,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will track these metrics as part of the experiment</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># associated to this pipeline. The metric definitions tells </span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker how to parse the values from the Training Job logs.</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>[</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"loss"</span>, <span class="st">"Regex"</span>: <span class="st">"loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_loss"</span>, <span class="st">"Regex"</span>: <span class="st">"val_loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    disable_profiler<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a>. This Training Step will create a SageMaker Training Job in the background, run the training script, and upload the output to S3. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TrainingStep">TrainingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>This step will receive the train and validation split from the previous step as inputs.</p>
<p>Here, we are using two input channels, <code>train</code> and <code>validation</code>. SageMaker will automatically create an environment variable corresponding to each of these channels following the format <code>SM_CHANNEL_[channel_name]</code>:</p>
<ul>
<li><code>SM_CHANNEL_TRAIN</code>: This environment variable will contain the path to the data in the <code>train</code> channel</li>
<li><code>SM_CHANNEL_VALIDATION</code>: This environment variable will contain the path to the data in the <code>validation</code> channel</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="293">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TrainingStep</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.inputs <span class="im">import</span> TrainingInput</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>train_model_step <span class="op">=</span> TrainingStep(</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"train-model"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>estimator.fit(</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"train"</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"validation"</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/svpino/dev/ml.school/.venv/lib/python3.9/site-packages/sagemaker/workflow/pipeline_context.py:297: UserWarning:

Running within a PipelineSession, there will be No Wait, No Logs, and No Job being started.
</code></pre>
</div>
</div>
</section>
<section id="tuning" class="level2">
<h2 class="anchored" data-anchor-id="tuning">Tuning</h2>
<p>We can also use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-tuning">Tuning Step</a> to build a model. This Tuning Step will create a SageMaker Hyperparameter Tuning Job in the background and use the training script to train different versions of the model to choose the best one.</p>
<p>Since we could use the Training of the Tuning Step to create the model, we’ll define a constant <code>USE_TUNING_STEP</code> to indicate which approach we want to run.</p>
<div class="cell" data-tags="[]" data-execution_count="294">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>USE_TUNING_STEP <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep">TuningStep</a> requires a <a href="https://sagemaker.readthedocs.io/en/stable/api/training/tuner.html">HyperparameterTuner</a> reference to configure the Hyperparameter Tuning Job.</p>
<p>Here is the configuration that we’ll use to find the best model:</p>
<ol type="1">
<li><code>objective_metric_name</code>: This is the name of the metric the tuner will use to determine the best model. We’ll use <code>val_accuracy</code> to select the model with the highest validation accuracy.</li>
<li><code>objective_type</code>: This is the objective of the tuner. It can be <code>Minimize</code> or <code>Maximize</code>. Since we are using the validation accuracy of the model, we want the objective to be <code>Maximize.</code> If we were using the loss of the model, we would set the objective to <code>Minimize.</code></li>
<li><code>metric_definitions</code>: This defines how SageMaker will determine the metric’s value by looking at the output logs of the training process.</li>
</ol>
<p>The tuner expects the list of the hyperparameters you want to explore. You can use subclasses of the <a href="https://sagemaker.readthedocs.io/en/stable/api/training/parameter.html#sagemaker.parameter.ParameterRange">Parameter</a> class to specify different types of hyperparameters. This example explores different values for the <code>epochs</code> hyperparameter.</p>
<p>You can control the number of jobs and how many of them will run in parallel using the following two arguments:</p>
<ul>
<li><code>max_jobs</code>: Defines the maximum total number of training jobs to start for the hyperparameter tuning job.</li>
<li><code>max_parallel_jobs</code>: Defines the maximum number of parallel training jobs to start.</li>
</ul>
<p>Finally, we’ll create the Tuning Step using the tuner. Notice how the Tuning Step looks very similar to the Training Step.</p>
<div class="cell" data-tags="[]" data-execution_count="295">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tuner <span class="im">import</span> HyperparameterTuner</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.parameter <span class="im">import</span> IntegerParameter</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TuningStep</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> HyperparameterTuner(</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    estimator,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    objective_metric_name <span class="op">=</span> <span class="st">"val_accuracy"</span>,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    objective_type<span class="op">=</span><span class="st">"Maximize"</span>,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    hyperparameter_ranges <span class="op">=</span> {</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: IntegerParameter(<span class="dv">10</span>, <span class="dv">50</span>),</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    metric_definitions <span class="op">=</span> [</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>}</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    max_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    max_parallel_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>tune_model_step <span class="op">=</span> TuningStep(</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">"tune-model"</span>,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>tuner.fit(</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"train"</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"validation"</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation" class="level2">
<h2 class="anchored" data-anchor-id="evaluation">Evaluation</h2>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to evaluate the model.</p>
<p>Let’s create the evaluation script. The Processing Step will spin up a Processing Job and run this script inside a container. This script is responsible for loading the model we created and evaluating it on the test set. Before finishing, this script will generate an evaluation report of the model.</p>
<div class="cell" data-tags="[]" data-execution_count="296">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>MODEL_PATH <span class="op">=</span> <span class="st">"/opt/ml/processing/model/"</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>TEST_PATH <span class="op">=</span> <span class="st">"/opt/ml/processing/test/"</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">"/opt/ml/processing/evaluation/"</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate(model_path, test_path, output_path):</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The first step is to extract the model package so we can load </span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it in memory.</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(Path(model_path) <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        tar.extractall(path<span class="op">=</span>Path(model_path))</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> keras.models.load_model(Path(model_path) <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> pd.read_csv(Path(test_path) <span class="op">/</span> <span class="st">"test.csv"</span>)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> X_test[X_test.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    X_test.drop(X_test.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_test), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(y_test, predictions)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Test accuracy: </span><span class="sc">{</span>accuracy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's create an evaluation report using the model accuracy.</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    evaluation_report <span class="op">=</span> {</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metrics"</span>: {</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"accuracy"</span>: {</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"value"</span>: accuracy</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>    Path(output_path).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(Path(output_path) <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>        f.write(json.dumps(evaluation_report))</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>    evaluate(</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>MODEL_PATH, </span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>        test_path<span class="op">=</span>TEST_PATH,</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">=</span>OUTPUT_PATH</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/evaluation.py</code></pre>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected.</p>
<div class="cell" data-tags="[]" data-execution_count="297">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> train <span class="im">import</span> train</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> evaluation <span class="im">import</span> evaluate</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>, </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After training a model, we need to prepare a package just like</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker would. This package is what the evaluation script is</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expecting as an input.</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>        tar.add(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>, arcname<span class="op">=</span><span class="st">"001"</span>)</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    evaluate(</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>directory, </span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        test_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"test"</span>,</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"evaluation"</span>,</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"evaluation"</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluate_generates_evaluation_report(directory):</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> os.listdir(directory)</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"evaluation.json"</span> <span class="kw">in</span> output</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluation_report_contains_accuracy(directory):</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"metrics"</span> <span class="kw">in</span> report</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"accuracy"</span> <span class="kw">in</span> report[<span class="st">"metrics"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.SGD` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.SGD`.
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpf79nisc5/model/001/assets
WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.RestoredOptimizer` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.RestoredOptimizer`.
WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.SGD` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.SGD`.
WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.SGD` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.SGD`.
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpd_5_ehu4/model/001/assets
WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.RestoredOptimizer` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.RestoredOptimizer`.
WARNING:absl:At this time, the v2.11+ optimizer `tf.keras.optimizers.SGD` runs slowly on M1/M2 Macs, please use the legacy Keras optimizer instead, located at `tf.keras.optimizers.legacy.SGD`.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>8/8 - 0s - loss: 1.7050 - accuracy: 0.2083 - val_loss: 1.5639 - val_accuracy: 0.1538 - 222ms/epoch - 28ms/step
2/2 [==============================] - 0s 1ms/step
Validation accuracy: 0.15384615384615385
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpf79nisc5/model/001/assets
2/2 [==============================] - 0s 2ms/step
Test accuracy: 0.19607843137254902
.8/8 - 0s - loss: 1.2137 - accuracy: 0.0458 - val_loss: 1.1446 - val_accuracy: 0.0769 - 220ms/epoch - 27ms/step
2/2 [==============================] - 0s 2ms/step
Validation accuracy: 0.07692307692307693
INFO:tensorflow:Assets written to: /var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpd_5_ehu4/model/001/assets
2/2 [==============================] - 0s 1ms/step
Test accuracy: 0.0392156862745098
.
2 passed in 1.26s</code></pre>
</div>
</div>
<p>To run the evaluation script, we’ll use a Processing Step with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks-tensorflow.html">TensorFlowProcessor</a>.</p>
<p>We can use the <code>USE_TUNING_STEP</code> flag to determine whether we created the model using a Training Step or a Tuning Step. In case we are using the Tuning Step, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep.get_top_model_s3_uri">TuningStep.get_top_model_s3_uri()</a> function to get the model artifacts from the top performing training job of the Hyperparameter Tuning Job.</p>
<p>The <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> lets us specify a list of <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.properties.PropertyFile">PropertyFile</a> instances from the output of the job. We can use this to map the evaluation report generated in the evaluation script. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-propertyfile.html">How to Build and Manage Property Files</a> for more information.</p>
<div class="cell" data-tags="[]" data-execution_count="298">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlowProcessor</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.properties <span class="im">import</span> PropertyFile</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>tensorflow_processor <span class="op">=</span> TensorFlowProcessor(</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"evaluation-processor"</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to map the evaluation report that we generate inside</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co"># the evaluation script so we can later reference it.</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>evaluation_report <span class="op">=</span> PropertyFile(</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluation-report"</span>,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    output_name<span class="op">=</span><span class="st">"evaluation"</span>,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="st">"evaluation.json"</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice how this step uses the model generated by the tuning or training</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co"># step, and the test set generated by the preprocessing step.</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>evaluate_model_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluate-model"</span>,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>tensorflow_processor.run(</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"test"</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>(</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>                    tune_model_step.get_top_model_s3_uri(top_k<span class="op">=</span><span class="dv">0</span>, s3_bucket<span class="op">=</span>config[<span class="st">"session"</span>].default_bucket()) </span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> USE_TUNING_STEP </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span> train_model_step.properties.ModelArtifacts.S3ModelArtifacts</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>,</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(output_name<span class="op">=</span><span class="st">"evaluation"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/evaluation"</span>),</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/evaluation.py"</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>    property_files<span class="op">=</span>[evaluation_report],</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/svpino/dev/ml.school/.venv/lib/python3.9/site-packages/sagemaker/workflow/pipeline_context.py:297: UserWarning:

Running within a PipelineSession, there will be No Wait, No Logs, and No Job being started.
</code></pre>
</div>
</div>
</section>
<section id="inference-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="inference-pipeline">Inference Pipeline</h2>
<p>Deploying the model we trained directly to an endpoint doesn’t lets us control the data that goes in and comes out of the endpoint. The TensorFlow model we trained requires the data to come in a specific format, which makes it useless to other applications. Fortunately, we can create an Inference Pipeline using SageMaker to control the data that goes in and comes out of the endpoint.</p>
<p>Our inference pipeline will have three components:</p>
<ol type="1">
<li>A preprocessing transformer that will transform the input data into the format the model expects.</li>
<li>The TensorFlow model we trained.</li>
<li>A postprocessing transformer that will transform the output of the model into a human-readable format.</li>
</ol>
<p>We want our endpoint to handle unprocessed data in CSV and JSON format and return the penguin’s species. Here is an example of the payload input we want the endpoint to support:</p>
<pre><code>{
    "island": "Biscoe",
    "culmen_length_mm": 48.6,
    "culmen_depth_mm": 16.0,
    "flipper_length_mm": 230.0,
    "body_mass_g": 5800.0,
}</code></pre>
<p>And here is an example of the output we’d like to get from the endpoint:</p>
<pre><code>{
    "prediction": "Adelie", 
    "confidence": 0.802672
}</code></pre>
<p>Let’s start by setting up a local folder where we will create the <code>inference.py</code> script.</p>
<div class="cell" data-tags="[]" data-execution_count="299">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>INFERENCE_CODE_FOLDER <span class="op">=</span> CODE_FOLDER <span class="op">/</span> <span class="st">"inference"</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>Path(INFERENCE_CODE_FOLDER).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="ss">f"./</span><span class="sc">{</span>INFERENCE_CODE_FOLDER<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="preprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-script">Preprocessing Script</h3>
<p>The first component of our inference pipeline is a transformer that will transform the input data into the format the model expects. We’ll use the Scikit-Learn transformer we saved when we split and transformed the data. To deploy this transformer as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the input data, and returns the output in the format the TensorFlow model expects.</p>
<div class="cell" data-tags="[]" data-execution_count="300">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> encoders, worker</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We don't have access to the `worker` instance when testing locally. </span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We'll set it to None so we can change the way functions create a response.</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>TARGET_COLUMN <span class="op">=</span> <span class="st">"species"</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>FEATURE_COLUMNS <span class="op">=</span> [</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"island"</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_length_mm"</span>,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_depth_mm"</span>, </span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flipper_length_mm"</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"body_mass_g"</span>,</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Parses the input payload and creates a Pandas DataFrame.</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="co">    This function will check whether the target column is present in the</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="co">    input data, and will remove it.</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(StringIO(input_data), header<span class="op">=</span><span class="va">None</span>, skipinitialspace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="bu">len</span>(FEATURE_COLUMNS) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> df.drop(df.columns[<span class="dv">0</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>        df.columns <span class="op">=</span> FEATURE_COLUMNS</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame([json.loads(input_data)])</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"species"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> df.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported.!"</span>)</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a><span class="co">    Formats the prediction output to generate a response.</span></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a><span class="co">    The default accept/content-type between containers for serial inference is JSON. </span></span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a><span class="co">    Since this model will preceed a TensorFlow model, we want to return a JSON object</span></span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a><span class="co">    following TensorFlow's input requirements.</span></span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"There was an error transforming the input data"</span>)</span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker.Response(encoders.encode(prediction, accept), mimetype<span class="op">=</span>accept) <span class="cf">if</span> worker <span class="cf">else</span> prediction, accept </span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>        instances <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> prediction.tolist()]</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> {<span class="st">"instances"</span>: instances}</span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept) <span class="cf">if</span> worker <span class="cf">else</span> (response, accept)</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"</span><span class="sc">{</span>accept<span class="sc">}</span><span class="ss"> accept type is not supported."</span>)</span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a><span class="co">    Preprocess the input using the transformer.</span></span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> model.transform(input_data)</span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response</span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error transforming the input data"</span>, e)</span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a><span class="co">    Deserializes the model that will be used in this container.</span></span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> joblib.load(os.path.join(model_dir, <span class="st">"features.joblib"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/inference/preprocessing_component.py</code></pre>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected.</p>
<div class="cell" data-tags="[]" data-execution_count="301">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing_component <span class="im">import</span> input_fn, predict_fn, output_fn, model_fn</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>        tar.extractall(path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_drops_target_column_if_present():</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="st">    Adelie, Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_drops_target_column_if_present():</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"species"</span>: <span class="st">"Adelie"</span>, </span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_works_without_target_column():</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_works_without_target_column():</span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_csv_raises_exception_if_prediction_is_none():</span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>):</span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>        output_fn(<span class="va">None</span>, <span class="st">"text/csv"</span>)</span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_json_raises_exception_if_prediction_is_none():</span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>):</span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a>        output_fn(<span class="va">None</span>, <span class="st">"application/json"</span>)</span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_csv_returns_prediction():</span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> np.array([</span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> output_fn(prediction, <span class="st">"text/csv"</span>)</span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response <span class="op">==</span> (prediction, <span class="st">"text/csv"</span>)</span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_json_returns_tensorflow_ready_input():</span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> np.array([</span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb60-97"><a href="#cb60-97" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb60-98"><a href="#cb60-98" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb60-99"><a href="#cb60-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-100"><a href="#cb60-100" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb60-101"><a href="#cb60-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-102"><a href="#cb60-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">0</span>] <span class="op">==</span> {</span>
<span id="cb60-103"><a href="#cb60-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instances"</span>: [</span>
<span id="cb60-104"><a href="#cb60-104" aria-hidden="true" tabindex="-1"></a>            [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb60-105"><a href="#cb60-105" aria-hidden="true" tabindex="-1"></a>            [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb60-106"><a href="#cb60-106" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb60-107"><a href="#cb60-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-108"><a href="#cb60-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-109"><a href="#cb60-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>] <span class="op">==</span> <span class="st">"application/json"</span></span>
<span id="cb60-110"><a href="#cb60-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-111"><a href="#cb60-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-112"><a href="#cb60-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_transforms_data(directory):</span>
<span id="cb60-113"><a href="#cb60-113" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb60-114"><a href="#cb60-114" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb60-115"><a href="#cb60-115" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb60-116"><a href="#cb60-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-117"><a href="#cb60-117" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(<span class="bu">str</span>(directory))</span>
<span id="cb60-118"><a href="#cb60-118" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb60-119"><a href="#cb60-119" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(df, model)</span>
<span id="cb60-120"><a href="#cb60-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">type</span>(response) <span class="kw">is</span> np.ndarray</span>
<span id="cb60-121"><a href="#cb60-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-122"><a href="#cb60-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-123"><a href="#cb60-123" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_none_if_invalid_input(directory):</span>
<span id="cb60-124"><a href="#cb60-124" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb60-125"><a href="#cb60-125" aria-hidden="true" tabindex="-1"></a><span class="st">    Invalid, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb60-126"><a href="#cb60-126" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb60-127"><a href="#cb60-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-128"><a href="#cb60-128" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(<span class="bu">str</span>(directory))</span>
<span id="cb60-129"><a href="#cb60-129" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb60-130"><a href="#cb60-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> predict_fn(df, model) <span class="kw">is</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>..........                                                                                   [100%]
10 passed in 0.06s</code></pre>
</div>
</div>
</section>
<section id="postprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="postprocessing-script">Postprocessing Script</h3>
<p>The final component of our inference pipeline is a transformer that will transform the output from the model into a human-readable format. We’ll use the Scikit-Learn target transformer we saved when we split and transformed the data. To deploy this transformer as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the output from the model, and returns a human-readable format.</p>
<div class="cell" data-tags="[]" data-execution_count="302">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer, make_column_selector</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline, make_pipeline</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, LabelEncoder, StandardScaler, OrdinalEncoder</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pickle <span class="im">import</span> dump, load</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> encoders, worker</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We don't have access to the `worker` instance when testing locally. </span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We'll set it to None so we can change the way functions create a response.</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> json.loads(input_data)[<span class="st">"predictions"</span>]</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported.!"</span>)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker.Response(encoders.encode(prediction, accept), mimetype<span class="op">=</span>accept) <span class="cf">if</span> worker <span class="cf">else</span> (prediction, accept)</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> []</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p, c <span class="kw">in</span> prediction:</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>            response.append({</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">"prediction"</span>: p,</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">"confidence"</span>: c</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept) <span class="cf">if</span> worker <span class="cf">else</span> (response, accept)</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> RuntimeException(<span class="ss">f"</span><span class="sc">{</span>accept<span class="sc">}</span><span class="ss"> accept type is not supported."</span>)</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Transforms the prediction into its corresponding category.</span></span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> np.argmax(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>    confidence <span class="op">=</span> np.<span class="bu">max</span>(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [(confidence, model[prediction]) <span class="cf">for</span> confidence, prediction <span class="kw">in</span> <span class="bu">zip</span>(confidence, predictions)]</span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a><span class="co">    Deserializes the target model and returns the list of fitted categories.</span></span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> joblib.load(os.path.join(model_dir, <span class="st">"target.joblib"</span>))</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model.named_transformers_[<span class="st">"species"</span>].categories_[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/inference/postprocessing_component.py</code></pre>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected.</p>
<div class="cell" data-tags="[]" data-execution_count="303">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> postprocessing_component <span class="im">import</span> predict_fn</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_prediction_as_last_column():</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> [</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.6</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>], </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>],</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.7</span>]</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> [<span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span>, <span class="st">"Chinstrap"</span>]</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(input_data, categories)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response <span class="op">==</span> [</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.6</span>, <span class="st">"Adelie"</span>),</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.8</span>, <span class="st">"Gentoo"</span>),</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.7</span>, <span class="st">"Chinstrap"</span>)</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.                                                                                            [100%]
1 passed in 0.01s</code></pre>
</div>
</div>
</section>
<section id="pipeline-model" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-model">Pipeline Model</h3>
<p>We can now create a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/pipeline.html#sagemaker.pipeline.PipelineModel">PipelineModel</a> to define our inference pipeline. This Pipeline Model will create a SageMaker Model in the background and use the preprocessing and postprocessing scripts to transform the input and output of the model.</p>
<div class="cell" data-tags="[]" data-execution_count="304">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> Join</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.model <span class="im">import</span> SKLearnModel</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow.model <span class="im">import</span> TensorFlowModel</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.pipeline <span class="im">import</span> PipelineModel</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll use the model we generated from the first step of the</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># pipeline as the input to the first and last components of the</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># inference pipeline. This model.tar.gz file contains the two</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># transformers we need to preprocess and postprocess the data.</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>transformation_pipeline_model <span class="op">=</span> Join(</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"/"</span>,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span>[</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>        split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model.tar.gz"</span>,</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the first component of the inference pipeline. It will</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess the data before sending it to the TensorFlow model.</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>preprocessing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"preprocessing_component.py"</span>,</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="bu">str</span>(INFERENCE_CODE_FOLDER),</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>tensorflow_model <span class="op">=</span> TensorFlowModel(</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>(</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>        tune_model_step.get_top_model_s3_uri(</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>            top_k<span class="op">=</span><span class="dv">0</span>, s3_bucket<span class="op">=</span>config[<span class="st">"session"</span>].default_bucket()</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> USE_TUNING_STEP</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> train_model_step.properties.ModelArtifacts.S3ModelArtifacts</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the last component of the inference pipeline. It will</span></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a><span class="co"># postprocess the output from the TensorFlow model before sending </span></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="co"># it back to the user.</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>post_processing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"postprocessing_component.py"</span>,</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="bu">str</span>(INFERENCE_CODE_FOLDER),</span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a><span class="co"># We can now create the inference pipeline using the three models.</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>pipeline_model <span class="op">=</span> PipelineModel(</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"inference-model"</span>,</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[preprocessing_model, tensorflow_model, post_processing_model],</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-quality-baseline" class="level2">
<h2 class="anchored" data-anchor-id="data-quality-baseline">Data Quality Baseline</h2>
<p>We need to create a data quality baseline to compare against the real-time traffic our endpoint receives. This baseline will help us detect any data dristribution shifts.</p>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> to generate the baseline and configure the instance that will run the quality check using the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#checkjobconfig">CheckJobConfig</a> class.</p>
<div class="cell" data-tags="[]" data-execution_count="305">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.check_job_config <span class="im">import</span> CheckJobConfig</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> (</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    DataQualityCheckConfig,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    QualityCheckStep,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor.dataset_format <span class="im">import</span> DatasetFormat</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-quality"</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>data_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-data-quality-baseline"</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    check_job_config<span class="op">=</span>CheckJobConfig(</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>pipeline_session,</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    quality_check_config<span class="op">=</span>DataQualityCheckConfig(</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/data"</span>,</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">True</span>, output_columns_position<span class="op">=</span><span class="st">"END"</span>),</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>DATA_QUALITY_LOCATION,</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker.image_uris:Defaulting to the only supported framework/algorithm version: .
INFO:sagemaker.image_uris:Ignoring unnecessary instance type: None.</code></pre>
</div>
</div>
</section>
<section id="model-quality-baseline" class="level2">
<h2 class="anchored" data-anchor-id="model-quality-baseline">Model Quality Baseline</h2>
<p>To monitor the performance of the model, we need to generate a baseline performance. This baseline will help us detect any performance degradation.</p>
<p>To create the baseline, we must generate predictions for the test set and compare them with the predictions from the model. We can do this by running a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html">Batch Transform Job</a> to generate predictions for every sample from the test set. We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> as part of the pipeline to run this job. We’ll configure the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html">Batch Transform Job</a> using a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a>.</p>
<div class="cell" data-tags="[]" data-execution_count="306">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TransformStep</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.model_step <span class="im">import</span> ModelStep</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.transformer <span class="im">import</span> Transformer</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The Transform Step requires a model to generate predictions, </span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># so we need to create the inference pipeline model.</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>create_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"create"</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"create-model"</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.create(</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.m5.xlarge"</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>transformer <span class="op">=</span> Transformer(</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span>create_model_step.properties.ModelName,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span><span class="st">"MultiRecord"</span>,</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    accept<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    assemble_with<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/transform"</span>,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>]</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>generate_test_predictions_step <span class="op">=</span> TransformStep(</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-test-predictions"</span>,</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>transformer.transform(</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We will use the baseline set we generated when we split the data.</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This set corresponds to the test split before the transformation step.</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>split_and_transform_data_step.properties.ProcessingOutputConfig.Outputs[<span class="st">"baseline"</span>].S3Output.S3Uri,</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>        join_source<span class="op">=</span><span class="st">"Input"</span>,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>        split_type<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>        input_filter<span class="op">=</span><span class="st">"$"</span>,</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We want to output the first and the last field from the joint set.</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The first field corresponds to the groundtruth, and the last field</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># corresponds to the prediction.</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>        output_filter<span class="op">=</span><span class="st">"$[0,-1]"</span>,</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/svpino/dev/ml.school/.venv/lib/python3.9/site-packages/sagemaker/workflow/pipeline_context.py:297: UserWarning:

Running within a PipelineSession, there will be No Wait, No Logs, and No Job being started.

INFO:botocore.credentials:Found credentials in shared credentials file: ~/.aws/credentials</code></pre>
</div>
</div>
<p>Let’s now configure the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> and feed it the data we generated in the Transform Step.</p>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model-quality">Model Quality Step</a> to generate the baseline, and we’ll configure the instance that will run the quality check using the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#modelqualityjobconfig">ModelQualityJobConfig</a> class.</p>
<div class="cell" data-tags="[]" data-execution_count="307">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> ModelQualityCheckConfig</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>MODEL_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/model-quality"</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>model_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-model-quality-baseline"</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    check_job_config <span class="op">=</span> CheckJobConfig(</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>pipeline_session,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    quality_check_config <span class="op">=</span> ModelQualityCheckConfig(</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We are going to use the output of the Transform Step to generate</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the model quality baseline.</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span>generate_test_predictions_step.properties.TransformOutput.S3OutputPath,</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to specify the problem type and the fields where the prediction</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and groundtruth are so the process knows how to interpret the results.</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Since the data doesn't have headers, SageMaker will autocreate headers for it.</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># _c0 corresponds to the first column, and _c1 corresponds to the second column.</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>        ground_truth_attribute<span class="op">=</span><span class="st">"_c0"</span>,</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"_c1"</span>,</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>MODEL_QUALITY_LOCATION,</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker.image_uris:Defaulting to the only supported framework/algorithm version: .
INFO:sagemaker.image_uris:Ignoring unnecessary instance type: None.</code></pre>
</div>
</div>
</section>
<section id="registration" class="level2">
<h2 class="anchored" data-anchor-id="registration">Registration</h2>
<p>We can now register the inference pipeline in the Model Registry.</p>
<p>When we register a model, we can specify a set of <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">ModelMetrics</a> that will be saved in the Model Registry. We’ll use the metrics that we calculated using the Quality Check Steps.</p>
<div class="cell" data-tags="[]" data-execution_count="308">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_metrics <span class="im">import</span> MetricsSource, ModelMetrics </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.drift_check_baselines <span class="im">import</span> DriftCheckBaselines</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>drift_check_baselines <span class="op">=</span> DriftCheckBaselines(</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use a <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.model_step.ModelStep">ModelStep</a> to register the model.</p>
<div class="cell" data-tags="[]" data-execution_count="309">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"penguins"</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"register"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"register-model"</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.register(</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        model_package_group_name<span class="op">=</span>MODEL_PACKAGE_GROUP,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        drift_check_baselines<span class="op">=</span>drift_check_baselines,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        approval_status<span class="op">=</span><span class="st">"PendingManualApproval"</span>,</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Our inference pipeline model supports two content </span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># types: text/csv and application/json.</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>        content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>        response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],       </span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is the suggested inference instance types when </span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># deploying the model or using it as part of a batch</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># transform job.</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        inference_instances<span class="op">=</span>[<span class="st">"ml.m5.xlarge"</span>],</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>        transform_instances<span class="op">=</span>[<span class="st">"ml.m5.xlarge"</span>],</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>        domain<span class="op">=</span><span class="st">"MACHINE_LEARNING"</span>,</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"CLASSIFICATION"</span>,</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        framework<span class="op">=</span><span class="st">"TENSORFLOW"</span>,</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="condition-step" class="level2">
<h2 class="anchored" data-anchor-id="condition-step">Condition Step</h2>
<p>We only want to register the model and generate the baseline predictions if the model’s accuracy exceeds a predefined threshold. We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> together with the evaluation report we generated to accomplish this. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#conditionstep">ConditionStep</a> SageMaker’s SDK documentation for more information. In this example, we will use a <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.conditions.ConditionGreaterThanOrEqualTo">ConditionGreaterThanOrEqualTo</a> condition to compare the model’s accuracy with the threshold. Look at the <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_building_pipeline.html#conditions">Conditions</a> section in the documentation for more information about the types of supported conditions.</p>
<p>If the model’s accuracy is not greater than or equal our threshold, we will send the pipeline to a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-fail">Fail Step</a> with the appropriate error message. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.fail_step.FailStep">FailStep</a> SageMaker’s SDK documentation for more information.</p>
<p>We are going to use a new <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameter</a> in our pipeline to specify the minimum accuracy that the model should reach for it to be registered.</p>
<div class="cell" data-tags="[]" data-execution_count="310">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.fail_step <span class="im">import</span> FailStep</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> JsonGet</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> Join</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterFloat</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.conditions <span class="im">import</span> ConditionGreaterThanOrEqualTo</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.condition_step <span class="im">import</span> ConditionStep</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>accuracy_threshold <span class="op">=</span> ParameterFloat(name<span class="op">=</span><span class="st">"accuracy_threshold"</span>, default_value<span class="op">=</span><span class="fl">0.70</span>)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We want to check whether the accuracy of the model is greater than</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the threshold we defined.</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        ConditionGreaterThanOrEqualTo(</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>            left<span class="op">=</span>JsonGet(</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>                step_name<span class="op">=</span>evaluate_model_step.name,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>                property_file<span class="op">=</span>evaluation_report,</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>                json_path<span class="op">=</span><span class="st">"metrics.accuracy.value"</span>,</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>            right<span class="op">=</span>accuracy_threshold,</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[]</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> LOCAL_MODE</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> [</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>        create_model_step,</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>        generate_test_predictions_step,</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>        model_quality_baseline_step,</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>        register_model_step,</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the condition is not met, we want to fail the execution</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># of the pipeline by sending it to a FailStep.</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>        FailStep(</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"fail"</span>,</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>            error_message<span class="op">=</span>Join(</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>                on<span class="op">=</span><span class="st">" "</span>,</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>                values<span class="op">=</span>[</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Execution failed because the model's accuracy was lower than"</span>,</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>                    accuracy_threshold,</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pipeline" class="level2">
<h2 class="anchored" data-anchor-id="pipeline">Pipeline</h2>
<p>We can now create the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-execution_count="311">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_definition_config <span class="im">import</span> PipelineDefinitionConfig</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"cohort-pipeline"</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        dataset_location,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        accuracy_threshold,</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        split_and_transform_data_step,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        train_model_step <span class="cf">if</span> <span class="kw">not</span> USE_TUNING_STEP <span class="cf">else</span> tune_model_step,</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        condition_step</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>PipelineDefinitionConfig(use_custom_job_prefix<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker doesn't support running any of these steps in Local Mode.</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    pipeline.steps.extend([data_quality_baseline_step])</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="311">
<pre><code>{'PipelineArn': 'cohort-pipeline'}</code></pre>
</div>
</div>
<div class="alert" style="background-color:#0066cc;">
To run the pipeline, comment out the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute the cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="312">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%script false --no-raise-error</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
WARNING:sagemaker.workflow.utilities:Popping out 'TrainingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-23-222/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-23-222/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-23-989/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-23-989/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-24-565/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-24-565/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
WARNING:sagemaker.workflow.utilities:Popping out 'TrainingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-25-535/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-25-535/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-26-086/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-26-086/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-26-534/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-26-534/source/runproc.sh
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.local.image:'Docker Compose' found using Docker CLI.
INFO:sagemaker.local.local_session:Starting processing job
INFO:sagemaker.local.image:Using the long-lived AWS credentials found in session
INFO:sagemaker.local.image:docker compose file: 
networks:
  sagemaker-local:
    name: sagemaker-local
services:
  algo-1-11uyr:
    container_name: z95a9txez0-algo-1-11uyr
    entrypoint:
    - python3
    - /opt/ml/processing/input/code/preprocessor.py
    environment:
    - '[Masked]'
    - '[Masked]'
    image: 683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3
    networks:
      sagemaker-local:
        aliases:
        - algo-1-11uyr
    stdin_open: true
    tty: true
    volumes:
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp76takbc2/algo-1-11uyr/config:/opt/ml/config
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp76takbc2/algo-1-11uyr/output:/opt/ml/output
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp3og0t308:/opt/ml/processing/input
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpi2ttx5h6:/opt/ml/processing/input/code
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnbs8q41l/output/train:/opt/ml/processing/train
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnbs8q41l/output/validation:/opt/ml/processing/validation
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnbs8q41l/output/test:/opt/ml/processing/test
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnbs8q41l/output/model:/opt/ml/processing/model
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnbs8q41l/output/baseline:/opt/ml/processing/baseline
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp76takbc2/shared:/opt/ml/shared
version: '2.3'

INFO:sagemaker.local.image:docker command: docker compose -f /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp76takbc2/docker-compose.yaml up --build --abort-on-container-exit
WARNING:sagemaker.workflow.utilities:Popping out 'TrainingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.local.image:'Docker Compose' found using Docker CLI.
INFO:sagemaker.local.local_session:Starting training job
INFO:sagemaker.local.image:Using the long-lived AWS credentials found in session
INFO:sagemaker.local.image:docker compose file: 
networks:
  sagemaker-local:
    name: sagemaker-local
services:
  algo-1-vb8is:
    command: train
    container_name: lyrronf17q-algo-1-vb8is
    environment:
    - '[Masked]'
    - '[Masked]'
    - '[Masked]'
    - '[Masked]'
    image: sagemaker-tensorflow-training-toolkit-local
    networks:
      sagemaker-local:
        aliases:
        - algo-1-vb8is
    stdin_open: true
    tty: true
    volumes:
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8r1o388c/algo-1-vb8is/output/data:/opt/ml/output/data
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8r1o388c/algo-1-vb8is/input:/opt/ml/input
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8r1o388c/algo-1-vb8is/output:/opt/ml/output
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8r1o388c/model:/opt/ml/model
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpnuidaskc:/opt/ml/input/data/train
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp3j14r_n6:/opt/ml/input/data/validation
version: '2.3'

INFO:sagemaker.local.image:docker command: docker compose -f /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8r1o388c/docker-compose.yaml up --build --abort-on-container-exit
INFO:sagemaker.processing:Uploaded None to s3://mlschool/evaluation-processor-2023-10-20-15-03-42-919/source/sourcedir.tar.gz
INFO:sagemaker.processing:runproc.sh uploaded to s3://mlschool/evaluation-processor-2023-10-20-15-03-42-919/source/runproc.sh
/Users/svpino/dev/ml.school/.venv/lib/python3.9/site-packages/sagemaker/workflow/pipeline_context.py:297: UserWarning:

Running within a PipelineSession, there will be No Wait, No Logs, and No Job being started.

WARNING:sagemaker.workflow.utilities:Popping out 'ProcessingJobName' from the pipeline definition by default since it will be overridden at pipeline execution time. Please utilize the PipelineDefinitionConfig to persist this field in the pipeline definition if desired.
INFO:sagemaker.local.image:'Docker Compose' found using Docker CLI.
INFO:sagemaker.local.local_session:Starting processing job
INFO:sagemaker.local.image:Using the long-lived AWS credentials found in session
INFO:sagemaker.local.image:docker compose file: 
networks:
  sagemaker-local:
    name: sagemaker-local
services:
  algo-1-2t8nd:
    container_name: ymgdk4sfdc-algo-1-2t8nd
    entrypoint:
    - /bin/bash
    - /opt/ml/processing/input/entrypoint/runproc.sh
    environment:
    - '[Masked]'
    - '[Masked]'
    image: sagemaker-tensorflow-training-toolkit-local
    networks:
      sagemaker-local:
        aliases:
        - algo-1-2t8nd
    stdin_open: true
    tty: true
    volumes:
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp6u04qqo7/algo-1-2t8nd/config:/opt/ml/config
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp6u04qqo7/algo-1-2t8nd/output:/opt/ml/output
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpag42z8wx:/opt/ml/processing/test
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp8wvnrp0d:/opt/ml/processing/model
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp45bhq7eb:/opt/ml/processing/input/code/
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp31p5c6lj:/opt/ml/processing/input/entrypoint
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmpivgeah7f/output/evaluation:/opt/ml/processing/evaluation
    - /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp6u04qqo7/shared:/opt/ml/shared
version: '2.3'

INFO:sagemaker.local.image:docker command: docker compose -f /private/var/folders/4c/v1q3hy1x4mb5w0wpc72zl3_w0000gp/T/tmp6u04qqo7/docker-compose.yaml up --build --abort-on-container-exit</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting execution for pipeline cohort-pipeline. Execution ID is ef2a475a-e7e7-4a54-8ff4-9e3b2cd4eac3
Starting pipeline step: 'split-and-transform-data'
Container z95a9txez0-algo-1-11uyr  Creating
algo-1-11uyr The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested 
Container z95a9txez0-algo-1-11uyr  Created
Attaching to z95a9txez0-algo-1-11uyr
z95a9txez0-algo-1-11uyr exited with code 0
Aborting on container exit...
Container z95a9txez0-algo-1-11uyr  Stopping
Container z95a9txez0-algo-1-11uyr  Stopped
===== Job Complete =====
Pipeline step 'split-and-transform-data' SUCCEEDED.
Starting pipeline step: 'train-model'
Container lyrronf17q-algo-1-vb8is  Creating
Container lyrronf17q-algo-1-vb8is  Created
Attaching to lyrronf17q-algo-1-vb8is
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,168 botocore.credentials INFO     Found credentials in environment variables.
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,467 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,471 sagemaker-training-toolkit INFO     No Neurons detected (normal if no neurons installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,481 sagemaker-training-toolkit INFO     instance_groups entry not present in resource_config
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,487 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,490 sagemaker-training-toolkit INFO     No Neurons detected (normal if no neurons installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,500 sagemaker-training-toolkit INFO     instance_groups entry not present in resource_config
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,508 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,510 sagemaker-training-toolkit INFO     No Neurons detected (normal if no neurons installed)
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,518 sagemaker-training-toolkit INFO     instance_groups entry not present in resource_config
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,521 sagemaker-training-toolkit INFO     Invoking user script
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | Training Env:
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | {
lyrronf17q-algo-1-vb8is  |     "additional_framework_parameters": {},
lyrronf17q-algo-1-vb8is  |     "channel_input_dirs": {
lyrronf17q-algo-1-vb8is  |         "train": "/opt/ml/input/data/train",
lyrronf17q-algo-1-vb8is  |         "validation": "/opt/ml/input/data/validation"
lyrronf17q-algo-1-vb8is  |     },
lyrronf17q-algo-1-vb8is  |     "current_host": "algo-1-vb8is",
lyrronf17q-algo-1-vb8is  |     "current_instance_group": "homogeneousCluster",
lyrronf17q-algo-1-vb8is  |     "current_instance_group_hosts": [],
lyrronf17q-algo-1-vb8is  |     "current_instance_type": "local",
lyrronf17q-algo-1-vb8is  |     "distribution_hosts": [
lyrronf17q-algo-1-vb8is  |         "algo-1-vb8is"
lyrronf17q-algo-1-vb8is  |     ],
lyrronf17q-algo-1-vb8is  |     "distribution_instance_groups": [],
lyrronf17q-algo-1-vb8is  |     "framework_module": null,
lyrronf17q-algo-1-vb8is  |     "hosts": [
lyrronf17q-algo-1-vb8is  |         "algo-1-vb8is"
lyrronf17q-algo-1-vb8is  |     ],
lyrronf17q-algo-1-vb8is  |     "hyperparameters": {
lyrronf17q-algo-1-vb8is  |         "epochs": 50,
lyrronf17q-algo-1-vb8is  |         "batch_size": 32,
lyrronf17q-algo-1-vb8is  |         "model_dir": "s3://mlschool/training-2023-10-20-15-03-22-962/model"
lyrronf17q-algo-1-vb8is  |     },
lyrronf17q-algo-1-vb8is  |     "input_config_dir": "/opt/ml/input/config",
lyrronf17q-algo-1-vb8is  |     "input_data_config": {
lyrronf17q-algo-1-vb8is  |         "train": {
lyrronf17q-algo-1-vb8is  |             "TrainingInputMode": "File",
lyrronf17q-algo-1-vb8is  |             "ContentType": "text/csv"
lyrronf17q-algo-1-vb8is  |         },
lyrronf17q-algo-1-vb8is  |         "validation": {
lyrronf17q-algo-1-vb8is  |             "TrainingInputMode": "File",
lyrronf17q-algo-1-vb8is  |             "ContentType": "text/csv"
lyrronf17q-algo-1-vb8is  |         }
lyrronf17q-algo-1-vb8is  |     },
lyrronf17q-algo-1-vb8is  |     "input_dir": "/opt/ml/input",
lyrronf17q-algo-1-vb8is  |     "instance_groups": [],
lyrronf17q-algo-1-vb8is  |     "instance_groups_dict": {},
lyrronf17q-algo-1-vb8is  |     "is_hetero": false,
lyrronf17q-algo-1-vb8is  |     "is_master": true,
lyrronf17q-algo-1-vb8is  |     "is_modelparallel_enabled": null,
lyrronf17q-algo-1-vb8is  |     "is_smddpmprun_installed": false,
lyrronf17q-algo-1-vb8is  |     "job_name": "train-model-1697814215-c254",
lyrronf17q-algo-1-vb8is  |     "log_level": 20,
lyrronf17q-algo-1-vb8is  |     "master_hostname": "algo-1-vb8is",
lyrronf17q-algo-1-vb8is  |     "model_dir": "/opt/ml/model",
lyrronf17q-algo-1-vb8is  |     "module_dir": "s3://mlschool/training-2023-10-20-15-03-35-427/source/sourcedir.tar.gz",
lyrronf17q-algo-1-vb8is  |     "module_name": "train",
lyrronf17q-algo-1-vb8is  |     "network_interface_name": "eth0",
lyrronf17q-algo-1-vb8is  |     "num_cpus": 5,
lyrronf17q-algo-1-vb8is  |     "num_gpus": 0,
lyrronf17q-algo-1-vb8is  |     "num_neurons": 0,
lyrronf17q-algo-1-vb8is  |     "output_data_dir": "/opt/ml/output/data",
lyrronf17q-algo-1-vb8is  |     "output_dir": "/opt/ml/output",
lyrronf17q-algo-1-vb8is  |     "output_intermediate_dir": "/opt/ml/output/intermediate",
lyrronf17q-algo-1-vb8is  |     "resource_config": {
lyrronf17q-algo-1-vb8is  |         "current_host": "algo-1-vb8is",
lyrronf17q-algo-1-vb8is  |         "hosts": [
lyrronf17q-algo-1-vb8is  |             "algo-1-vb8is"
lyrronf17q-algo-1-vb8is  |         ]
lyrronf17q-algo-1-vb8is  |     },
lyrronf17q-algo-1-vb8is  |     "user_entry_point": "train.py"
lyrronf17q-algo-1-vb8is  | }
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | Environment variables:
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | SM_HOSTS=["algo-1-vb8is"]
lyrronf17q-algo-1-vb8is  | SM_NETWORK_INTERFACE_NAME=eth0
lyrronf17q-algo-1-vb8is  | SM_HPS={"batch_size":32,"epochs":50,"model_dir":"s3://mlschool/training-2023-10-20-15-03-22-962/model"}
lyrronf17q-algo-1-vb8is  | SM_USER_ENTRY_POINT=train.py
lyrronf17q-algo-1-vb8is  | SM_FRAMEWORK_PARAMS={}
lyrronf17q-algo-1-vb8is  | SM_RESOURCE_CONFIG={"current_host":"algo-1-vb8is","hosts":["algo-1-vb8is"]}
lyrronf17q-algo-1-vb8is  | SM_INPUT_DATA_CONFIG={"train":{"ContentType":"text/csv","TrainingInputMode":"File"},"validation":{"ContentType":"text/csv","TrainingInputMode":"File"}}
lyrronf17q-algo-1-vb8is  | SM_OUTPUT_DATA_DIR=/opt/ml/output/data
lyrronf17q-algo-1-vb8is  | SM_CHANNELS=["train","validation"]
lyrronf17q-algo-1-vb8is  | SM_CURRENT_HOST=algo-1-vb8is
lyrronf17q-algo-1-vb8is  | SM_CURRENT_INSTANCE_TYPE=local
lyrronf17q-algo-1-vb8is  | SM_CURRENT_INSTANCE_GROUP=homogeneousCluster
lyrronf17q-algo-1-vb8is  | SM_CURRENT_INSTANCE_GROUP_HOSTS=[]
lyrronf17q-algo-1-vb8is  | SM_INSTANCE_GROUPS=[]
lyrronf17q-algo-1-vb8is  | SM_INSTANCE_GROUPS_DICT={}
lyrronf17q-algo-1-vb8is  | SM_DISTRIBUTION_INSTANCE_GROUPS=[]
lyrronf17q-algo-1-vb8is  | SM_IS_HETERO=false
lyrronf17q-algo-1-vb8is  | SM_MODULE_NAME=train
lyrronf17q-algo-1-vb8is  | SM_LOG_LEVEL=20
lyrronf17q-algo-1-vb8is  | SM_FRAMEWORK_MODULE=
lyrronf17q-algo-1-vb8is  | SM_INPUT_DIR=/opt/ml/input
lyrronf17q-algo-1-vb8is  | SM_INPUT_CONFIG_DIR=/opt/ml/input/config
lyrronf17q-algo-1-vb8is  | SM_OUTPUT_DIR=/opt/ml/output
lyrronf17q-algo-1-vb8is  | SM_NUM_CPUS=5
lyrronf17q-algo-1-vb8is  | SM_NUM_GPUS=0
lyrronf17q-algo-1-vb8is  | SM_NUM_NEURONS=0
lyrronf17q-algo-1-vb8is  | SM_MODEL_DIR=/opt/ml/model
lyrronf17q-algo-1-vb8is  | SM_MODULE_DIR=s3://mlschool/training-2023-10-20-15-03-35-427/source/sourcedir.tar.gz
lyrronf17q-algo-1-vb8is  | SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"train":"/opt/ml/input/data/train","validation":"/opt/ml/input/data/validation"},"current_host":"algo-1-vb8is","current_instance_group":"homogeneousCluster","current_instance_group_hosts":[],"current_instance_type":"local","distribution_hosts":["algo-1-vb8is"],"distribution_instance_groups":[],"framework_module":null,"hosts":["algo-1-vb8is"],"hyperparameters":{"batch_size":32,"epochs":50,"model_dir":"s3://mlschool/training-2023-10-20-15-03-22-962/model"},"input_config_dir":"/opt/ml/input/config","input_data_config":{"train":{"ContentType":"text/csv","TrainingInputMode":"File"},"validation":{"ContentType":"text/csv","TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","instance_groups":[],"instance_groups_dict":{},"is_hetero":false,"is_master":true,"is_modelparallel_enabled":null,"is_smddpmprun_installed":false,"job_name":"train-model-1697814215-c254","log_level":20,"master_hostname":"algo-1-vb8is","model_dir":"/opt/ml/model","module_dir":"s3://mlschool/training-2023-10-20-15-03-35-427/source/sourcedir.tar.gz","module_name":"train","network_interface_name":"eth0","num_cpus":5,"num_gpus":0,"num_neurons":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-vb8is","hosts":["algo-1-vb8is"]},"user_entry_point":"train.py"}
lyrronf17q-algo-1-vb8is  | SM_USER_ARGS=["--batch_size","32","--epochs","50","--model_dir","s3://mlschool/training-2023-10-20-15-03-22-962/model"]
lyrronf17q-algo-1-vb8is  | SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
lyrronf17q-algo-1-vb8is  | SM_CHANNEL_TRAIN=/opt/ml/input/data/train
lyrronf17q-algo-1-vb8is  | SM_CHANNEL_VALIDATION=/opt/ml/input/data/validation
lyrronf17q-algo-1-vb8is  | SM_HP_EPOCHS=50
lyrronf17q-algo-1-vb8is  | SM_HP_BATCH_SIZE=32
lyrronf17q-algo-1-vb8is  | SM_HP_MODEL_DIR=s3://mlschool/training-2023-10-20-15-03-22-962/model
lyrronf17q-algo-1-vb8is  | PYTHONPATH=/opt/ml/code:/root/miniconda3/envs/ml-dependencies/bin:/root/miniconda3/envs/ml-dependencies/lib/python39.zip:/root/miniconda3/envs/ml-dependencies/lib/python3.9:/root/miniconda3/envs/ml-dependencies/lib/python3.9/lib-dynload:/root/miniconda3/envs/ml-dependencies/lib/python3.9/site-packages
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | Invoking script with the following command:
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | /root/miniconda3/envs/ml-dependencies/bin/python train.py --batch_size 32 --epochs 50 --model_dir s3://mlschool/training-2023-10-20-15-03-22-962/model
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | 
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:37,522 sagemaker-training-toolkit INFO     Exceptions not imported for SageMaker Debugger as it is not installed.
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:38,615 numexpr.utils INFO     NumExpr defaulting to 5 threads.
lyrronf17q-algo-1-vb8is  | Epoch 1/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 1.1680 - accuracy: 0.4283 - val_loss: 1.1430 - val_accuracy: 0.4369 - 254ms/epoch - 16ms/step
lyrronf17q-algo-1-vb8is  | Epoch 2/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 1.0998 - accuracy: 0.5031 - val_loss: 1.0632 - val_accuracy: 0.5243 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 3/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 1.0330 - accuracy: 0.6050 - val_loss: 0.9739 - val_accuracy: 0.7379 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 4/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.9526 - accuracy: 0.7484 - val_loss: 0.8759 - val_accuracy: 0.8447 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 5/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.8715 - accuracy: 0.7775 - val_loss: 0.7880 - val_accuracy: 0.8544 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 6/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.7981 - accuracy: 0.7838 - val_loss: 0.7052 - val_accuracy: 0.8544 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 7/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.7284 - accuracy: 0.7859 - val_loss: 0.6331 - val_accuracy: 0.8544 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 8/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.6681 - accuracy: 0.7859 - val_loss: 0.5682 - val_accuracy: 0.8544 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 9/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.6152 - accuracy: 0.7859 - val_loss: 0.5164 - val_accuracy: 0.8544 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 10/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.5703 - accuracy: 0.7859 - val_loss: 0.4708 - val_accuracy: 0.8544 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 11/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.5319 - accuracy: 0.7859 - val_loss: 0.4344 - val_accuracy: 0.8544 - 19ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 12/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.4985 - accuracy: 0.7859 - val_loss: 0.4035 - val_accuracy: 0.8544 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 13/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.4697 - accuracy: 0.7859 - val_loss: 0.3761 - val_accuracy: 0.8544 - 26ms/epoch - 2ms/step
lyrronf17q-algo-1-vb8is  | Epoch 14/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.4455 - accuracy: 0.7859 - val_loss: 0.3531 - val_accuracy: 0.8544 - 26ms/epoch - 2ms/step
lyrronf17q-algo-1-vb8is  | Epoch 15/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.4241 - accuracy: 0.7859 - val_loss: 0.3340 - val_accuracy: 0.8544 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 16/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.4056 - accuracy: 0.7859 - val_loss: 0.3181 - val_accuracy: 0.8544 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 17/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3889 - accuracy: 0.7859 - val_loss: 0.3054 - val_accuracy: 0.8641 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 18/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3722 - accuracy: 0.8129 - val_loss: 0.2906 - val_accuracy: 0.9126 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 19/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3579 - accuracy: 0.8420 - val_loss: 0.2788 - val_accuracy: 0.9417 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 20/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3446 - accuracy: 0.8857 - val_loss: 0.2669 - val_accuracy: 0.9417 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 21/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3323 - accuracy: 0.8919 - val_loss: 0.2573 - val_accuracy: 0.9515 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 22/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3187 - accuracy: 0.9272 - val_loss: 0.2473 - val_accuracy: 0.9709 - 23ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 23/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.3067 - accuracy: 0.9459 - val_loss: 0.2379 - val_accuracy: 0.9709 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 24/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2963 - accuracy: 0.9501 - val_loss: 0.2296 - val_accuracy: 0.9709 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 25/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2867 - accuracy: 0.9501 - val_loss: 0.2208 - val_accuracy: 0.9709 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 26/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2776 - accuracy: 0.9501 - val_loss: 0.2131 - val_accuracy: 0.9709 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 27/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2688 - accuracy: 0.9543 - val_loss: 0.2059 - val_accuracy: 0.9709 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 28/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2606 - accuracy: 0.9605 - val_loss: 0.1988 - val_accuracy: 0.9709 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 29/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2509 - accuracy: 0.9626 - val_loss: 0.1926 - val_accuracy: 0.9709 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 30/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2430 - accuracy: 0.9647 - val_loss: 0.1866 - val_accuracy: 0.9709 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 31/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2354 - accuracy: 0.9647 - val_loss: 0.1806 - val_accuracy: 0.9709 - 23ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 32/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2279 - accuracy: 0.9647 - val_loss: 0.1734 - val_accuracy: 0.9709 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 33/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2204 - accuracy: 0.9647 - val_loss: 0.1676 - val_accuracy: 0.9709 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 34/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2121 - accuracy: 0.9647 - val_loss: 0.1613 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 35/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.2048 - accuracy: 0.9667 - val_loss: 0.1564 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 36/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1981 - accuracy: 0.9667 - val_loss: 0.1516 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 37/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1915 - accuracy: 0.9688 - val_loss: 0.1468 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 38/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1852 - accuracy: 0.9688 - val_loss: 0.1443 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 39/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1779 - accuracy: 0.9813 - val_loss: 0.1387 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 40/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1716 - accuracy: 0.9834 - val_loss: 0.1328 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 41/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1657 - accuracy: 0.9792 - val_loss: 0.1283 - val_accuracy: 0.9806 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 42/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1600 - accuracy: 0.9813 - val_loss: 0.1234 - val_accuracy: 0.9806 - 23ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 43/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1533 - accuracy: 0.9834 - val_loss: 0.1190 - val_accuracy: 0.9806 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 44/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1478 - accuracy: 0.9834 - val_loss: 0.1146 - val_accuracy: 0.9806 - 22ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 45/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1427 - accuracy: 0.9834 - val_loss: 0.1100 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 46/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1372 - accuracy: 0.9834 - val_loss: 0.1065 - val_accuracy: 0.9903 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 47/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1324 - accuracy: 0.9896 - val_loss: 0.1019 - val_accuracy: 0.9806 - 20ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 48/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1277 - accuracy: 0.9875 - val_loss: 0.0986 - val_accuracy: 0.9903 - 21ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 49/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1231 - accuracy: 0.9896 - val_loss: 0.0954 - val_accuracy: 0.9903 - 23ms/epoch - 1ms/step
lyrronf17q-algo-1-vb8is  | Epoch 50/50
lyrronf17q-algo-1-vb8is  | 16/16 - 0s - loss: 0.1187 - accuracy: 0.9896 - val_loss: 0.0923 - val_accuracy: 0.9903 - 22ms/epoch - 1ms/step
4/4 [==============================] - 0s 599us/step
lyrronf17q-algo-1-vb8is  | Validation accuracy: 0.9902912621359223
lyrronf17q-algo-1-vb8is  | WARNING:absl:Found untraced functions such as _update_step_xla while saving (showing 1 of 1). These functions will not be directly callable after loading.
lyrronf17q-algo-1-vb8is  | 2023-10-20 15:03:42,111 sagemaker-training-toolkit INFO     Reporting training SUCCESS
lyrronf17q-algo-1-vb8is exited with code 0
Aborting on container exit...
Container lyrronf17q-algo-1-vb8is  Stopping
Container lyrronf17q-algo-1-vb8is  Stopped
===== Job Complete =====
Pipeline step 'train-model' SUCCEEDED.
Starting pipeline step: 'evaluate-model'
Container ymgdk4sfdc-algo-1-2t8nd  Creating
Container ymgdk4sfdc-algo-1-2t8nd  Created
Attaching to ymgdk4sfdc-algo-1-2t8nd
4/4 [==============================] - 0s 594us/step
ymgdk4sfdc-algo-1-2t8nd  | Test accuracy: 1.0
ymgdk4sfdc-algo-1-2t8nd exited with code 0
Aborting on container exit...
Container ymgdk4sfdc-algo-1-2t8nd  Stopping
Container ymgdk4sfdc-algo-1-2t8nd  Stopped
===== Job Complete =====
Pipeline step 'evaluate-model' SUCCEEDED.
Starting pipeline step: 'check-model-accuracy'
Pipeline step 'check-model-accuracy' SUCCEEDED.
Pipeline execution ef2a475a-e7e7-4a54-8ff4-9e3b2cd4eac3 SUCCEEDED</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="312">
<pre><code>&lt;sagemaker.local.entities._LocalPipelineExecution at 0x31e4af6d0&gt;</code></pre>
</div>
</div>
</section>
<section id="quality-baselines" class="level2">
<h2 class="anchored" data-anchor-id="quality-baselines">Quality Baselines</h2>
<p>Our pipeline generated data baseline statistics and constraints using our train set. We can take a look at what these values look like by downloading them from S3.</p>
<div class="cell" data-tags="[]" data-execution_count="243">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> JSON</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Downloader</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>statistics <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(S3Downloader.read_file(statistics))</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>JSON(response <span class="kw">or</span> {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="243">
<pre><code>&lt;IPython.core.display.JSON object&gt;</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="244">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(S3Downloader.read_file(constraints))</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>JSON(response <span class="kw">or</span> {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="244">
<pre><code>&lt;IPython.core.display.JSON object&gt;</code></pre>
</div>
</div>
<p>We also generated the baseline performance using the test set.</p>
<div class="cell" data-tags="[]" data-execution_count="245">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(S3Downloader.read_file(constraints))</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>JSON(response <span class="kw">or</span> {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="245">
<pre><code>&lt;IPython.core.display.JSON object&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="model-deployment" class="level1">
<h1>Model Deployment</h1>
<p>To deploy the model, we will use <a href="https://aws.amazon.com/pm/eventbridge/">Amazon EventBridge</a> to trigger a Lambda function that will deploy the model whenever its status changes to “Approved.”</p>
<section id="lambda" class="level2">
<h2 class="anchored" data-anchor-id="lambda">Lambda</h2>
<p>Let’s start by writing the Lambda function to take the model information and create a new endpoint.</p>
<p>We’ll enable <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-data-capture.html">Data Capture</a> as part of the endpoint configuration. With Data Capture we can record the inputs and outputs of the endpoint to use them later for monitoring the model: * <code>InitialSamplingPercentage</code> represents the percentage of traffic that we want to capture. * <code>DestinationS3Uri</code> specifies the S3 location where we want to store the captured data.</p>
<div class="cell" data-tags="[]" data-execution_count="246">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>sagemaker <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lambda_handler(event, context):</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    model_package_arn <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelPackageArn"</span>]</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    approval_status <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelApprovalStatus"</span>]</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Model: "</span><span class="sc">{</span>model_package_arn<span class="sc">}</span><span class="ss">". Approval Status: "</span><span class="sc">{</span>approval_status<span class="sc">}</span><span class="ss">"'</span>)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We only want to deploy the model if it's new approval</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># status is "Approved."</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> approval_status <span class="op">!=</span> <span class="st">"Approved"</span>:</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"statusCode"</span>: <span class="dv">200</span>,</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"body"</span>: json.dumps(<span class="ss">f'Skipping deployment. Approval status: "</span><span class="sc">{</span>approval_status<span class="sc">}</span><span class="ss">"'</span>)</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>        }    </span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    endpoint_name <span class="op">=</span> os.environ[<span class="st">"ENDPOINT"</span>]</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    data_capture_destination <span class="op">=</span> os.environ[<span class="st">"DATA_CAPTURE_DESTINATION"</span>]</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>    role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> time.strftime(<span class="st">"%m</span><span class="sc">%d</span><span class="st">%H%M%S"</span>, time.localtime())</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-model-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>    endpoint_config_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-config-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>    sagemaker.create_model(</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>        ModelName<span class="op">=</span>model_name, </span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>        ExecutionRoleArn<span class="op">=</span>role, </span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>        Containers<span class="op">=</span>[{</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelPackageName"</span>: model_package_arn</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>        }] </span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>    sagemaker.create_endpoint_config(</span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>        EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>        ProductionVariants<span class="op">=</span>[{</span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelName"</span>: model_name,</span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InstanceType"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialVariantWeight"</span>: <span class="dv">1</span>,</span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialInstanceCount"</span>: <span class="dv">1</span>,</span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"VariantName"</span>: <span class="st">"AllTraffic"</span>,</span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>        }],</span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We can enable Data Capture to record the inputs and outputs of the endpoint</span></span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to use them later for monitoring the model. </span></span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>        DataCaptureConfig<span class="op">=</span>{</span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"EnableCapture"</span>: <span class="va">True</span>,</span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialSamplingPercentage"</span>: <span class="dv">100</span>,</span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DestinationS3Uri"</span>: data_capture_destination,</span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CaptureOptions"</span>: [</span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"CaptureMode"</span>: <span class="st">"Input"</span></span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"CaptureMode"</span>: <span class="st">"Output"</span></span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CaptureContentTypeHeader"</span>: {</span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>                <span class="st">"CsvContentTypes"</span>: [</span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text/csv"</span>,</span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/octect-stream"</span></span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>                <span class="st">"JsonContentTypes"</span>: [</span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/json"</span>,</span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/octect-stream"</span></span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker.list_endpoints(NameContains<span class="op">=</span>endpoint_name, MaxResults<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(response[<span class="st">"Endpoints"</span>]) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the endpoint doesn't exist, let's create it.</span></span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a>        sagemaker.create_endpoint(</span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>            EndpointName<span class="op">=</span>endpoint_name, </span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb88-85"><a href="#cb88-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the endpoint already exist, let's update it with the</span></span>
<span id="cb88-86"><a href="#cb88-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new configuration.</span></span>
<span id="cb88-87"><a href="#cb88-87" aria-hidden="true" tabindex="-1"></a>        sagemaker.update_endpoint(</span>
<span id="cb88-88"><a href="#cb88-88" aria-hidden="true" tabindex="-1"></a>            EndpointName<span class="op">=</span>endpoint_name, </span>
<span id="cb88-89"><a href="#cb88-89" aria-hidden="true" tabindex="-1"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb88-90"><a href="#cb88-90" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb88-91"><a href="#cb88-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-92"><a href="#cb88-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb88-93"><a href="#cb88-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">"statusCode"</span>: <span class="dv">200</span>,</span>
<span id="cb88-94"><a href="#cb88-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body"</span>: json.dumps(<span class="st">"Endpoint deployed successfully"</span>)</span>
<span id="cb88-95"><a href="#cb88-95" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/lambda.py</code></pre>
</div>
</div>
<p>We need to ensure our Lambda function has permission to interact with SageMaker, so let’s create a new role and then create the lambda function.</p>
<div class="cell" data-tags="[]" data-execution_count="247">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>ENDPOINT <span class="op">=</span> <span class="st">"penguins-endpoint"</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>DATA_CAPTURE_DESTINATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-capture"</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>lambda_role_name <span class="op">=</span> <span class="st">"lambda-deployment-role"</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>lambda_role_arn <span class="op">=</span> <span class="va">None</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.create_role(</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        RoleName <span class="op">=</span> lambda_role_name,</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>        AssumeRolePolicyDocument <span class="op">=</span> json.dumps({</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Version"</span>: <span class="st">"2012-10-17"</span>,</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Statement"</span>: [</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Effect"</span>: <span class="st">"Allow"</span>,</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Principal"</span>: {</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Service"</span>: [</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"lambda.amazonaws.com"</span>,</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"events.amazonaws.com"</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>                        ]</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>                    },</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Action"</span>: <span class="st">"sts:AssumeRole"</span>,</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>        }),</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        Description<span class="op">=</span><span class="st">"Lambda Endpoint Deployment"</span></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>,</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span>lambda_role_arn</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"</span>,</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span>lambda_role_arn</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Role "</span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss">" created with ARN "</span><span class="sc">{</span>lambda_role_arn<span class="sc">}</span><span class="ss">".'</span>)</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> iam_client.exceptions.EntityAlreadyExistsException:</span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Role </span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss"> already exists."</span>)</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.get_role(RoleName<span class="op">=</span>lambda_role_name)</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Role lambda-deployment-role already exists.</code></pre>
</div>
</div>
<p>Let’s create the Lambda function.</p>
<div class="cell" data-tags="[]" data-execution_count="248">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.lambda_helper <span class="im">import</span> Lambda</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>deploy_lambda_fn <span class="op">=</span> Lambda(</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    function_name<span class="op">=</span><span class="st">"deploy_fn"</span>,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    execution_role_arn<span class="op">=</span>lambda_role_arn,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    script<span class="op">=</span><span class="bu">str</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"lambda.py"</span>),</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">=</span><span class="st">"lambda.lambda_handler"</span>,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    timeout<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    session<span class="op">=</span>sagemaker_session,</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    runtime<span class="op">=</span><span class="st">"python3.11"</span>,</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span>{</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Variables"</span>: {</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ENDPOINT"</span>: ENDPOINT,</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DATA_CAPTURE_DESTINATION"</span>: DATA_CAPTURE_DESTINATION,</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ROLE"</span>: role,</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>lambda_response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    lambda_response <span class="op">=</span> deploy_lambda_fn.upsert()</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>lambda_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="248">
<pre><code>{'ResponseMetadata': {'RequestId': '1e676d09-bacc-4b88-af4b-086aed5abe16',
  'HTTPStatusCode': 200,
  'HTTPHeaders': {'date': 'Thu, 19 Oct 2023 19:51:18 GMT',
   'content-type': 'application/json',
   'content-length': '1428',
   'connection': 'keep-alive',
   'x-amzn-requestid': '1e676d09-bacc-4b88-af4b-086aed5abe16'},
  'RetryAttempts': 0},
 'FunctionName': 'deploy_fn',
 'FunctionArn': 'arn:aws:lambda:us-east-1:325223348818:function:deploy_fn',
 'Runtime': 'python3.11',
 'Role': 'arn:aws:iam::325223348818:role/lambda-deployment-role',
 'Handler': 'lambda.lambda_handler',
 'CodeSize': 3142,
 'Description': '',
 'Timeout': 600,
 'MemorySize': 128,
 'LastModified': '2023-10-19T19:51:18.000+0000',
 'CodeSha256': 'GvIH6E8ZyghrSf4h2g/j+qIcE0HVvoFrno9erm8Qheo=',
 'Version': '$LATEST',
 'Environment': {'Variables': {'ROLE': 'arn:aws:iam::325223348818:role/service-role/AmazonSageMaker-ExecutionRole-20230312T160501',
   'DATA_CAPTURE_DESTINATION': 's3://mlschool/penguins/monitoring/data-capture',
   'ENDPOINT': 'penguins-endpoint'}},
 'TracingConfig': {'Mode': 'PassThrough'},
 'RevisionId': '11ecfd01-0601-44e1-8bf6-1b47d75f4ccd',
 'Layers': [],
 'State': 'Active',
 'LastUpdateStatus': 'InProgress',
 'LastUpdateStatusReason': 'The function is being created.',
 'LastUpdateStatusReasonCode': 'Creating',
 'PackageType': 'Zip',
 'Architectures': ['x86_64'],
 'EphemeralStorage': {'Size': 512},
 'SnapStart': {'ApplyOn': 'None', 'OptimizationStatus': 'Off'},
 'RuntimeVersionConfig': {'RuntimeVersionArn': 'arn:aws:lambda:us-east-1::runtime:6cf63f1a78b5c5e19617d6b4b111370fdbda415ea91bdfdc5aacef9fee76b64a'}}</code></pre>
</div>
</div>
</section>
<section id="eventbridge" class="level2">
<h2 class="anchored" data-anchor-id="eventbridge">EventBridge</h2>
<p>Let’s create an EventBridge rule that triggers the deployment process whenever a model approval status becomes “Approved”.</p>
<div class="cell" data-tags="[]" data-execution_count="249">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>events_client <span class="op">=</span> boto3.client(<span class="st">"events"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>event_pattern <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  "source": ["aws.sagemaker"],</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail-type": ["SageMaker Model Package State Change"],</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail": </span><span class="ch">{{</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelPackageGroupName": ["</span><span class="sc">{</span>MODEL_PACKAGE_GROUP<span class="sc">}</span><span class="ss">"],</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelApprovalStatus": ["Approved"]</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="ch">}}</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>rule_response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  rule_response <span class="op">=</span> events_client.put_rule(</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>      Name<span class="op">=</span><span class="st">"model-approval-rule"</span>,</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>      EventPattern<span class="op">=</span>event_pattern,</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>      State<span class="op">=</span><span class="st">"ENABLED"</span>,</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>      RoleArn<span class="op">=</span>role,</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>  response <span class="op">=</span> events_client.put_targets(</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>      Rule<span class="op">=</span><span class="st">"model-approval-rule"</span>,</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>      Targets<span class="op">=</span>[</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>          {</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Id"</span>: <span class="st">"1"</span>,</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Arn"</span>: lambda_response[<span class="st">"FunctionArn"</span>],</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>rule_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="249">
<pre><code>{'RuleArn': 'arn:aws:events:us-east-1:325223348818:rule/model-approval-rule',
 'ResponseMetadata': {'RequestId': 'a8d3fda6-0bf6-49f6-a28e-7cd6aac2b28f',
  'HTTPStatusCode': 200,
  'HTTPHeaders': {'x-amzn-requestid': 'a8d3fda6-0bf6-49f6-a28e-7cd6aac2b28f',
   'content-type': 'application/x-amz-json-1.1',
   'content-length': '76',
   'date': 'Thu, 19 Oct 2023 19:51:18 GMT'},
  'RetryAttempts': 0}}</code></pre>
</div>
</div>
<p>We need to give the event permissions to invoke the Lambda function.</p>
<div class="cell" data-tags="[]" data-execution_count="250">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>lambda_client <span class="op">=</span> boto3.client(<span class="st">"lambda"</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> lambda_client.add_permission(</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>            Action<span class="op">=</span><span class="st">"lambda:InvokeFunction"</span>,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>            FunctionName<span class="op">=</span>lambda_response[<span class="st">"FunctionName"</span>],</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>            Principal<span class="op">=</span><span class="st">"events.amazonaws.com"</span>,</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>            SourceArn<span class="op">=</span>rule_response[<span class="st">"RuleArn"</span>],</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>            StatementId<span class="op">=</span><span class="st">"EventBridge"</span>,</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> lambda_client.exceptions.ResourceConflictException <span class="im">as</span> e:</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Function "</span><span class="sc">{</span>lambda_response[<span class="st">"FunctionName"</span>]<span class="sc">}</span><span class="ss">" already has the correct permissions.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function "deploy_fn" already has the correct permissions.</code></pre>
</div>
</div>
</section>
<section id="predictions" class="level2">
<h2 class="anchored" data-anchor-id="predictions">Predictions</h2>
<p>Let’s now test the endpoint we deployed automatically with the pipeline. We will use the function to create a predictor with a JSON encoder and decoder.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="251">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.predictor <span class="im">import</span> Predictor</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> CSVSerializer</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>waiter <span class="op">=</span> sagemaker_client.get_waiter(<span class="st">"endpoint_in_service"</span>)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>waiter.wait(</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    EndpointName<span class="op">=</span>ENDPOINT,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    WaiterConfig<span class="op">=</span>{</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Delay"</span>: <span class="dv">10</span>,</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MaxAttempts"</span>: <span class="dv">30</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT, </span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>CSVSerializer(),</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> data.iloc[:<span class="dv">3</span>].to_csv(header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.decode(<span class="st">"utf-8"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-capture" class="level2">
<h2 class="anchored" data-anchor-id="data-capture">Data Capture</h2>
<p>Let’s check the S3 location where the endpoint stores the requests and responses that it receives.</p>
<p>Notice that it make take a few minutes for the first few files to show up in S3. Keep running the following line until you get some.</p>
<div class="cell" data-tags="[]" data-execution_count="252">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> S3Downloader.<span class="bu">list</span>(DATA_CAPTURE_DESTINATION)[:<span class="dv">3</span>]</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="252">
<pre><code>['s3://mlschool/penguins/monitoring/data-capture/penguins-endpoint/AllTraffic/2023/09/25/13/15-40-735-9cc3750d-ba42-472c-903d-969695d2096d.jsonl',
 's3://mlschool/penguins/monitoring/data-capture/penguins-endpoint/AllTraffic/2023/09/27/15/45-31-289-001fc69f-c352-4da2-b57a-a3a69fe3fecf.jsonl',
 's3://mlschool/penguins/monitoring/data-capture/penguins-endpoint/AllTraffic/2023/10/05/16/50-04-992-e16242d1-925c-4b07-9289-dffa0e026679.jsonl']</code></pre>
</div>
</div>
<p>These files contain the data captured by the endpoint in a SageMaker-specific JSON-line format. Each inference request is captured in a single line in the <code>jsonl</code> file. The line contains both the input and output merged together.</p>
<p>Let’s read the first line from the first file:</p>
<div class="cell" data-tags="[]" data-execution_count="253">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(files):</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> S3Downloader.read_file(files[<span class="dv">0</span>])</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(json.loads(lines.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)[<span class="dv">0</span>]), indent<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "captureData": {
    "endpointInput": {
      "observedContentType": "text/csv",
      "mode": "INPUT",
      "data": "Torgersen,39.1,18.7,181.0,3750.0,MALE\nTorgersen,39.5,17.4,186.0,3800.0,FEMALE\nTorgersen,40.3,18.0,195.0,3250.0,FEMALE\n",
      "encoding": "CSV"
    },
    "endpointOutput": {
      "observedContentType": "application/json",
      "mode": "OUTPUT",
      "data": "[{\"prediction\": \"Adelie\", \"confidence\": 0.775418103}, {\"prediction\": \"Adelie\", \"confidence\": 0.775709867}, {\"prediction\": \"Adelie\", \"confidence\": 0.67967391}]",
      "encoding": "JSON"
    }
  },
  "eventMetadata": {
    "eventId": "d33f9a23-5ae3-4403-9aa1-3759d7fa8015",
    "inferenceTime": "2023-09-25T13:15:40Z"
  },
  "eventVersion": "0"
}</code></pre>
</div>
</div>
</section>
<section id="clean-up" class="level2">
<h2 class="anchored" data-anchor-id="clean-up">Clean up</h2>
<p>Let’s now delete the endpoint.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="254">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>predictor.delete_endpoint()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-monitoring" class="level1">
<h1>Model Monitoring</h1>
<p>In this session we’ll set up a monitoring process to analyze the quality of the data our endpoint receives and the endpoint predictions. For this, we need to check the data received by the endpoint, generate ground truth labels, and compare them with a baseline performance.</p>
<p>To enable this functionality, we need a couple of steps:</p>
<ol type="1">
<li>Create baselines we can use to compare against real-time traffic.</li>
<li>Set up a schedule to continuously evaluate and compare against the baselines.</li>
</ol>
<p>Notice that we use the baseline datasets we generated during the Processing Step. These baseline datasets are the same unprocessed data in JSON format. We do this because we need raw data to compare against the endpoint input.</p>
<p>Check <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_monitoring.html">Amazon SageMaker Model Monitor</a> for a brief explanation of how to use SageMaker’s Model Monitoring functionality. <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor.html">Monitor models for data and model quality, bias, and explainability</a> is a much more extensive guide to monitoring in Amazon SageMaker.</p>
<div class="cell" data-tags="[]" data-execution_count="255">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/groundtruth"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fake-traffic" class="level2">
<h2 class="anchored" data-anchor-id="fake-traffic">Fake Traffic</h2>
<p>To test the monitoring functionality, we need to generate traffic to the endpoint.</p>
<p>To generate traffic, we will repeatedly send every sample from the dataset to the endpoint to simulate real prediction requests.</p>
<p>The following function will generate the traffic to the endpoint.</p>
<div class="cell" data-tags="[]" data-execution_count="256">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> Thread, Event</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_traffic(predictor):</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _predict(data, predictor, stop_traffic_thread):</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> data.iterrows():</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> row.tolist()</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> <span class="st">','</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, data))</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>            predictor.predict(data, inference_id<span class="op">=</span><span class="bu">str</span>(index), initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>            sleep(<span class="dv">1</span>)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_traffic_thread.is_set():</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_prediction_data(data, predictor, stop_traffic_thread):</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Generating </span><span class="sc">{</span>data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> predictions..."</span>)</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>            _predict(data, predictor, stop_traffic_thread)</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_traffic_thread.is_set():</span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>    stop_traffic_thread <span class="op">=</span> Event()</span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(DATA_FILEPATH, header<span class="op">=</span><span class="dv">0</span>).dropna()</span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>    data.drop([<span class="st">"species"</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>    traffic_thread <span class="op">=</span> Thread(</span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>_generate_prediction_data,</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(data, predictor, stop_traffic_thread,)</span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>    traffic_thread.start()</span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stop_traffic_thread, traffic_thread</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s wait for the endpoint to be in service, and then we can start generating traffic to the endpoint.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="257">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>waiter <span class="op">=</span> sagemaker_client.get_waiter(<span class="st">"endpoint_in_service"</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>waiter.wait(</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    EndpointName<span class="op">=</span>ENDPOINT,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    WaiterConfig<span class="op">=</span>{</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Delay"</span>: <span class="dv">10</span>,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MaxAttempts"</span>: <span class="dv">30</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT, </span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>CSVSerializer(),</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>stop_traffic_thread, traffic_thread <span class="op">=</span> generate_traffic(predictor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fake-labels" class="level2">
<h2 class="anchored" data-anchor-id="fake-labels">Fake Labels</h2>
<p>To test the performance of the model, we need to label the samples captured by the endpoint. We can simulate the labeling process by generating a random label for every sample. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-merge.html">Ingest Ground Truth Labels and Merge Them With Predictions</a> for more information about this.</p>
<div class="cell" data-tags="[]" data-execution_count="258">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_ground_truth_data(ground_truth_location):</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_ground_truth_record(inference_id):</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>        random.seed(inference_id)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"groundTruthData"</span>: {</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"data"</span>: random.choice([<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>]),</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">"encoding"</span>: <span class="st">"CSV"</span>,</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"eventMetadata"</span>: {</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"eventId"</span>: <span class="bu">str</span>(inference_id),</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"eventVersion"</span>: <span class="st">"0"</span>,</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _upload_ground_truth(records, upload_time):</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>        records <span class="op">=</span> [json.dumps(r) <span class="cf">for</span> r <span class="kw">in</span> records]</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(records)</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>        uri <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ground_truth_location<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>upload_time<span class="sc">:</span><span class="op">%</span>Y<span class="op">/%</span>m<span class="op">/%</span>d<span class="op">/%</span>H<span class="op">/%</span>M<span class="op">%</span>S<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Uploading ground truth data to </span><span class="sc">{</span>uri<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>        S3Uploader.upload_string_as_file_body(data, uri)    </span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_ground_truth_data(max_records, stop_ground_truth_thread):</span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>            records <span class="op">=</span> [_generate_ground_truth_record(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_records)]</span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>            _upload_ground_truth(records, datetime.utcnow())</span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_ground_truth_thread.is_set():</span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a>            sleep(<span class="dv">30</span>)</span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a>    stop_ground_truth_thread <span class="op">=</span> Event()</span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(DATA_FILEPATH).dropna()</span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-46"><a href="#cb107-46" aria-hidden="true" tabindex="-1"></a>    groundtruth_thread <span class="op">=</span> Thread(</span>
<span id="cb107-47"><a href="#cb107-47" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>_generate_ground_truth_data,</span>
<span id="cb107-48"><a href="#cb107-48" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(<span class="bu">len</span>(data), stop_ground_truth_thread,)</span>
<span id="cb107-49"><a href="#cb107-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb107-50"><a href="#cb107-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-51"><a href="#cb107-51" aria-hidden="true" tabindex="-1"></a>    groundtruth_thread.start()</span>
<span id="cb107-52"><a href="#cb107-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-53"><a href="#cb107-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stop_ground_truth_thread, groundtruth_thread</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start generating fake labels.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="259">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>stop_ground_truth_thread, groundtruth_thread <span class="op">=</span> generate_ground_truth_data(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    GROUND_TRUTH_LOCATION</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="monitoring-jobs" class="level2">
<h2 class="anchored" data-anchor-id="monitoring-jobs">Monitoring Jobs</h2>
<p>We can now schedule the Monitoring Jobs to continuously monitor the data going into the endpoint and the model performance. We will use the baseline we generated in the pipeline to determine when there’s drift. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-schedule-data-monitor.html">Schedule Data Quality Monitoring Jobs</a> and <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-schedule.html">Schedule Model Quality Monitoring Jobs</a> for more information.</p>
<p>The following functions will help us work with monitoring schedules later on.</p>
<div class="cell" data-tags="[]" data-execution_count="260">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_monitoring_schedules(endpoint_name):</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    schedules <span class="op">=</span> []</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.list_monitoring_schedules(EndpointName<span class="op">=</span>endpoint_name)[<span class="st">"MonitoringScheduleSummaries"</span>]</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> response:</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>        schedule <span class="op">=</span> {</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MonitoringScheduleName"</span>: name,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MonitoringType"</span>: item[<span class="st">"MonitoringType"</span>]</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>            MonitoringScheduleName<span class="op">=</span>name</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>        schedule[<span class="st">"Status"</span>] <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][<span class="st">"MonitoringExecutionStatus"</span>]</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> schedule[<span class="st">"Status"</span>] <span class="op">==</span> <span class="st">"Failed"</span>:</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>            schedule[<span class="st">"FailureReason"</span>] <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][<span class="st">"FailureReason"</span>]</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> schedule[<span class="st">"Status"</span>] <span class="op">==</span> <span class="st">"CompletedWithViolations"</span>:</span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>            processing_job_arn <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][<span class="st">"ProcessingJobArn"</span>]</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>            execution <span class="op">=</span> MonitoringExecution.from_processing_arn(</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>                sagemaker_session<span class="op">=</span>sagemaker_session, </span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>                processing_job_arn<span class="op">=</span>processing_job_arn</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>            execution_destination <span class="op">=</span> execution.output.destination</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>            violations_filepath <span class="op">=</span> os.path.join(execution_destination, <span class="st">"constraint_violations.json"</span>)</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>            violations <span class="op">=</span> json.loads(S3Downloader.read_file(violations_filepath))[<span class="st">"violations"</span>]</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>            schedule[<span class="st">"Violations"</span>] <span class="op">=</span> violations</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>        schedules.append(schedule)</span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> schedules</span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_monitoring_schedule(endpoint_name, monitoring_type):</span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>    schedules <span class="op">=</span> describe_monitoring_schedules(endpoint_name)</span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> schedule <span class="kw">in</span> schedules:</span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> schedule[<span class="st">"MonitoringType"</span>] <span class="op">==</span> monitoring_type:</span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>            found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(json.dumps(schedule, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> found:            </span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"There's no </span><span class="sc">{</span>monitoring_type<span class="sc">}</span><span class="ss"> Monitoring Schedule."</span>)</span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_data_monitoring_schedule(endpoint_name):</span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a>    describe_monitoring_schedule(endpoint_name, <span class="st">"DataQuality"</span>)</span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_model_monitoring_schedule(endpoint_name):</span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a>    describe_monitoring_schedule(endpoint_name, <span class="st">"ModelQuality"</span>)</span>
<span id="cb109-55"><a href="#cb109-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-56"><a href="#cb109-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-57"><a href="#cb109-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_monitoring_schedule(endpoint_name, monitoring_type):</span>
<span id="cb109-58"><a href="#cb109-58" aria-hidden="true" tabindex="-1"></a>    attempts <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb109-59"><a href="#cb109-59" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb109-60"><a href="#cb109-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-61"><a href="#cb109-61" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.list_monitoring_schedules(EndpointName<span class="op">=</span>endpoint_name)[<span class="st">"MonitoringScheduleSummaries"</span>]</span>
<span id="cb109-62"><a href="#cb109-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> response:</span>
<span id="cb109-63"><a href="#cb109-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> item[<span class="st">"MonitoringType"</span>] <span class="op">==</span> monitoring_type:</span>
<span id="cb109-64"><a href="#cb109-64" aria-hidden="true" tabindex="-1"></a>            found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb109-65"><a href="#cb109-65" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb109-66"><a href="#cb109-66" aria-hidden="true" tabindex="-1"></a>                MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb109-67"><a href="#cb109-67" aria-hidden="true" tabindex="-1"></a>            )[<span class="st">"MonitoringScheduleStatus"</span>]</span>
<span id="cb109-68"><a href="#cb109-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> status <span class="kw">in</span> (<span class="st">"Pending"</span>, <span class="st">"InProgress"</span>) <span class="kw">and</span> attempts <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb109-69"><a href="#cb109-69" aria-hidden="true" tabindex="-1"></a>                attempts <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb109-70"><a href="#cb109-70" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Monitoring schedule status: </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">. Waiting for it to finish."</span>)</span>
<span id="cb109-71"><a href="#cb109-71" aria-hidden="true" tabindex="-1"></a>                sleep(<span class="dv">30</span>)</span>
<span id="cb109-72"><a href="#cb109-72" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb109-73"><a href="#cb109-73" aria-hidden="true" tabindex="-1"></a>                status <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb109-74"><a href="#cb109-74" aria-hidden="true" tabindex="-1"></a>                    MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb109-75"><a href="#cb109-75" aria-hidden="true" tabindex="-1"></a>                )[<span class="st">"MonitoringScheduleStatus"</span>]</span>
<span id="cb109-76"><a href="#cb109-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-77"><a href="#cb109-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> status <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"Pending"</span>, <span class="st">"InProgress"</span>):</span>
<span id="cb109-78"><a href="#cb109-78" aria-hidden="true" tabindex="-1"></a>                sagemaker_client.delete_monitoring_schedule(</span>
<span id="cb109-79"><a href="#cb109-79" aria-hidden="true" tabindex="-1"></a>                    MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb109-80"><a href="#cb109-80" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb109-81"><a href="#cb109-81" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Monitoring schedule deleted."</span>)</span>
<span id="cb109-82"><a href="#cb109-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb109-83"><a href="#cb109-83" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Waiting for monitoring schedule timed out"</span>)</span>
<span id="cb109-84"><a href="#cb109-84" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb109-85"><a href="#cb109-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> found:            </span>
<span id="cb109-86"><a href="#cb109-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"There's no </span><span class="sc">{</span>monitoring_type<span class="sc">}</span><span class="ss"> Monitoring Schedule."</span>)</span>
<span id="cb109-87"><a href="#cb109-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-88"><a href="#cb109-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-89"><a href="#cb109-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_data_monitoring_schedule(endpoint_name):</span>
<span id="cb109-90"><a href="#cb109-90" aria-hidden="true" tabindex="-1"></a>    delete_monitoring_schedule(endpoint_name, <span class="st">"DataQuality"</span>)</span>
<span id="cb109-91"><a href="#cb109-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-92"><a href="#cb109-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-93"><a href="#cb109-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_model_monitoring_schedule(endpoint_name):</span>
<span id="cb109-94"><a href="#cb109-94" aria-hidden="true" tabindex="-1"></a>    delete_monitoring_schedule(endpoint_name, <span class="st">"ModelQuality"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="data-monitoring">Data Monitoring</h3>
<p>SageMaker looks for violations in the data captured by the endpoint. By default, it combines the input data with the endpoint output and compare the result with the baseline we generated. If we let SageMaker do this, we will get a few violations, for example an “extra column check” violation because the field <code>confidence</code> doesn’t exist in the baseline data.</p>
<p>We can fix these violations by creating a preprocessing script configuring the data we want the monitoring job to use. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-pre-and-post-processing.html">Preprocessing and Postprocessing</a> for more information about how to configure these scripts.</p>
<div class="cell" data-tags="[]" data-execution_count="261">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_PREPROCESSOR <span class="op">=</span> <span class="st">"data_quality_preprocessor.py"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="262">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_handler(inference_record):</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> inference_record.endpoint_input.data</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    output_data <span class="op">=</span> json.loads(inference_record.endpoint_output.data)</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(input_data)</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    response[<span class="st">"species"</span>] <span class="op">=</span> output_data[<span class="st">"prediction"</span>]</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The `response` variable contains the data that we want the</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># monitoring job to use to compare with the baseline.</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/data_quality_preprocessor.py</code></pre>
</div>
</div>
<p>The monitoring schedule expects an S3 location pointing to the preprocessing script. Let’s upload the script to the default bucket.</p>
<div class="cell" data-tags="[]" data-execution_count="263">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    bucket <span class="op">=</span> boto3.Session().resource(<span class="st">"s3"</span>).Bucket(pipeline_session.default_bucket())</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    prefix <span class="op">=</span> <span class="st">"penguins-monitoring"</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    bucket.Object(os.path.join(prefix, DATA_QUALITY_PREPROCESSOR)).upload_file(<span class="bu">str</span>(CODE_FOLDER <span class="op">/</span> DATA_QUALITY_PREPROCESSOR))</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    data_quality_preprocessor <span class="op">=</span> <span class="ss">f"s3://</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(bucket.name, prefix, DATA_QUALITY_PREPROCESSOR)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    data_quality_preprocessor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:botocore.credentials:Found credentials in shared credentials file: ~/.aws/credentials</code></pre>
</div>
</div>
<p>We can now set up the Data Quality Monitoring Job using the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.DefaultModelMonitor">DefaultModelMonitor</a> class. Notice how we specify the <code>record_preprocessor_script</code> using the S3 location where we uploaded our script.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="264">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> CronExpressionGenerator, DefaultModelMonitor</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>data_monitor <span class="op">=</span> DefaultModelMonitor(</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span><span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">3600</span>,</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>data_monitor.create_monitoring_schedule(</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-data-monitoring-schedule"</span>,</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    endpoint_input<span class="op">=</span>ENDPOINT,</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    record_preprocessor_script<span class="op">=</span>data_quality_preprocessor,</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    statistics<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span>,</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the results of the monitoring job by looking at whether it generated any violations.</p>
<div class="cell" data-tags="[]" data-execution_count="265">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>describe_data_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There's no DataQuality Monitoring Schedule.</code></pre>
</div>
</div>
</section>
<section id="model-monitoring-1" class="level3">
<h3 class="anchored" data-anchor-id="model-monitoring-1">Model Monitoring</h3>
<p>To set up a Model Quality Monitoring Job, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.ModelQualityMonitor">ModelQualityMonitor</a> class. The <a href="https://sagemaker.readthedocs.io/en/v2.24.2/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.EndpointInput">EndpointInput</a> instance configures the attribute the monitoring job should use to determine the prediction from the model.</p>
<p>Check <a href="https://sagemaker-examples.readthedocs.io/en/latest/sagemaker_model_monitor/model_quality/model_quality_churn_sdk.html">Amazon SageMaker Model Quality Monitor</a> for a complete tutorial on how to run a Model Monitoring Job in SageMaker.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="266">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> ModelQualityMonitor, EndpointInput</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>model_monitor <span class="op">=</span> ModelQualityMonitor(</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span><span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">1800</span>,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>model_monitor.create_monitoring_schedule(</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-model-monitoring-schedule"</span>,</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    endpoint_input <span class="op">=</span> EndpointInput(</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        destination<span class="op">=</span><span class="st">"/opt/ml/processing/input_data"</span>,</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    ground_truth_input<span class="op">=</span>GROUND_TRUTH_LOCATION,</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>    output_s3_uri<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/model-quality"</span>,</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the results of the monitoring job by looking at whether it generated any violations.</p>
<div class="cell" data-tags="[]" data-execution_count="267">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>describe_model_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There's no ModelQuality Monitoring Schedule.</code></pre>
</div>
</div>
</section>
<section id="clean-up-1" class="level3">
<h3 class="anchored" data-anchor-id="clean-up-1">Clean up</h3>
<p>The following code will stop the generation of traffic and labels, delete the monitoring jobs, and delete the endpoint.</p>
<div class="alert" style="background-color:#0066cc;">
Uncomment the <code style="background-color:#0066cc;">%%script</code> cell magic line to execute this cell.
</div>
<div class="cell" data-tags="[]" data-execution_count="268">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>stop_traffic_thread.<span class="bu">set</span>()</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>traffic_thread.join()</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>stop_ground_truth_thread.<span class="bu">set</span>()</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>groundtruth_thread.join()</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>delete_data_monitoring_schedule(ENDPOINT)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>delete_model_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>